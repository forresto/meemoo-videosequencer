/*

Meemoo HTML Audio Visual Sequencer
  by Forrest Oliphant
    at Sembiki Interactive http://sembiki.com/
    and Media Lab Helsinki http://mlab.taik.fi/
(copyleft) 2011

Built with backbone.js, jQuery, and jQueryUI in CoffeeScript
  http://documentcloud.github.com/backbone/
  http://jquery.com/
  http://jqueryui.com/
  http://jashkenas.github.com/coffee-script/



*///     Underscore.js 1.1.4
//     (c) 2011 Jeremy Ashkenas, DocumentCloud Inc.
//     Underscore is freely distributable under the MIT license.
//     Portions of Underscore are inspired or borrowed from Prototype,
//     Oliver Steele's Functional, and John Resig's Micro-Templating.
//     For all details and documentation:
//     http://documentcloud.github.com/underscore
function guid(){return S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4()}function S4(){return((1+Math.random())*65536|0).toString(16).substring(1)}(function(){var a=this,b=a._,c={},d=Array.prototype,e=Object.prototype,f=d.slice,g=d.unshift,h=e.toString,i=e.hasOwnProperty,j=d.forEach,k=d.map,l=d.reduce,m=d.reduceRight,n=d.filter,o=d.every,p=d.some,q=d.indexOf,r=d.lastIndexOf,s=Array.isArray,t=Object.keys,u=function(a){return new z(a)};typeof module!="undefined"&&module.exports?(module.exports=u,u._=u):a._=u,u.VERSION="1.1.4";var v=u.each=u.forEach=function(a,b,d){var e;if(a!=null)if(j&&a.forEach===j)a.forEach(b,d);else if(u.isNumber(a.length)){for(var f=0,g=a.length;f<g;f++)if(b.call(d,a[f],f,a)===c)return}else for(var h in a)if(i.call(a,h)&&b.call(d,a[h],h,a)===c)return};u.map=function(a,b,c){var d=[];if(a==null)return d;if(k&&a.map===k)return a.map(b,c);v(a,function(a,e,f){d[d.length]=b.call(c,a,e,f)});return d},u.reduce=u.foldl=u.inject=function(a,b,c,d){var e=c!==void 0;a==null&&(a=[]);if(l&&a.reduce===l){d&&(b=u.bind(b,d));return e?a.reduce(b,c):a.reduce(b)}v(a,function(a,f,g){!e&&f===0?(c=a,e=!0):c=b.call(d,c,a,f,g)});if(!e)throw new TypeError("Reduce of empty array with no initial value");return c},u.reduceRight=u.foldr=function(a,b,c,d){a==null&&(a=[]);if(m&&a.reduceRight===m){d&&(b=u.bind(b,d));return c!==void 0?a.reduceRight(b,c):a.reduceRight(b)}var e=(u.isArray(a)?a.slice():u.toArray(a)).reverse();return u.reduce(e,b,c,d)},u.find=u.detect=function(a,b,c){var d;w(a,function(a,e,f){if(b.call(c,a,e,f)){d=a;return!0}});return d},u.filter=u.select=function(a,b,c){var d=[];if(a==null)return d;if(n&&a.filter===n)return a.filter(b,c);v(a,function(a,e,f){b.call(c,a,e,f)&&(d[d.length]=a)});return d},u.reject=function(a,b,c){var d=[];if(a==null)return d;v(a,function(a,e,f){b.call(c,a,e,f)||(d[d.length]=a)});return d},u.every=u.all=function(a,b,d){b=b||u.identity;var e=!0;if(a==null)return e;if(o&&a.every===o)return a.every(b,d);v(a,function(a,f,g){if(!(e=e&&b.call(d,a,f,g)))return c});return e};var w=u.some=u.any=function(a,b,d){b=b||u.identity;var e=!1;if(a==null)return e;if(p&&a.some===p)return a.some(b,d);v(a,function(a,f,g){if(e=b.call(d,a,f,g))return c});return e};u.include=u.contains=function(a,b){var c=!1;if(a==null)return c;if(q&&a.indexOf===q)return a.indexOf(b)!=-1;w(a,function(a){if(c=a===b)return!0});return c},u.invoke=function(a,b){var c=f.call(arguments,2);return u.map(a,function(a){return(b?a[b]:a).apply(a,c)})},u.pluck=function(a,b){return u.map(a,function(a){return a[b]})},u.max=function(a,b,c){if(!b&&u.isArray(a))return Math.max.apply(Math,a);var d={computed:-Infinity};v(a,function(a,e,f){var g=b?b.call(c,a,e,f):a;g>=d.computed&&(d={value:a,computed:g})});return d.value},u.min=function(a,b,c){if(!b&&u.isArray(a))return Math.min.apply(Math,a);var d={computed:Infinity};v(a,function(a,e,f){var g=b?b.call(c,a,e,f):a;g<d.computed&&(d={value:a,computed:g})});return d.value},u.sortBy=function(a,b,c){return u.pluck(u.map(a,function(a,d,e){return{value:a,criteria:b.call(c,a,d,e)}}).sort(function(a,b){var c=a.criteria,d=b.criteria;return c<d?-1:c>d?1:0}),"value")},u.sortedIndex=function(a,b,c){c=c||u.identity;var d=0,e=a.length;while(d<e){var f=d+e>>1;c(a[f])<c(b)?d=f+1:e=f}return d},u.toArray=function(a){if(!a)return[];if(a.toArray)return a.toArray();if(u.isArray(a))return a;if(u.isArguments(a))return f.call(a);return u.values(a)},u.size=function(a){return u.toArray(a).length},u.first=u.head=function(a,b,c){return b&&!c?f.call(a,0,b):a[0]},u.rest=u.tail=function(a,b,c){return f.call(a,u.isUndefined(b)||c?1:b)},u.last=function(a){return a[a.length-1]},u.compact=function(a){return u.filter(a,function(a){return!!a})},u.flatten=function(a){return u.reduce(a,function(a,b){if(u.isArray(b))return a.concat(u.flatten(b));a[a.length]=b;return a},[])},u.without=function(a){var b=f.call(arguments,1);return u.filter(a,function(a){return!u.include(b,a)})},u.uniq=u.unique=function(a,b){return u.reduce(a,function(a,c,d){if(0==d||(b===!0?u.last(a)!=c:!u.include(a,c)))a[a.length]=c;return a},[])},u.intersect=function(a){var b=f.call(arguments,1);return u.filter(u.uniq(a),function(a){return u.every(b,function(b){return u.indexOf(b,a)>=0})})},u.zip=function(){var a=f.call(arguments),b=u.max(u.pluck(a,"length")),c=Array(b);for(var d=0;d<b;d++)c[d]=u.pluck(a,""+d);return c},u.indexOf=function(a,b,c){if(a==null)return-1;if(c){var d=u.sortedIndex(a,b);return a[d]===b?d:-1}if(q&&a.indexOf===q)return a.indexOf(b);for(var d=0,e=a.length;d<e;d++)if(a[d]===b)return d;return-1},u.lastIndexOf=function(a,b){if(a==null)return-1;if(r&&a.lastIndexOf===r)return a.lastIndexOf(b);var c=a.length;while(c--)if(a[c]===b)return c;return-1},u.range=function(a,b,c){var d=f.call(arguments),e=d.length<=1,a=e?0:d[0],b=e?d[0]:d[1],c=d[2]||1,g=Math.max(Math.ceil((b-a)/c),0),h=0,i=Array(g);while(h<g)i[h++]=a,a+=c;return i},u.bind=function(a,b){var c=f.call(arguments,2);return function(){return a.apply(b||{},c.concat(f.call(arguments)))}},u.bindAll=function(a){var b=f.call(arguments,1);b.length==0&&(b=u.functions(a)),v(b,function(b){a[b]=u.bind(a[b],a)});return a},u.memoize=function(a,b){var c={};b=b||u.identity;return function(){var d=b.apply(this,arguments);return d in c?c[d]:c[d]=a.apply(this,arguments)}},u.delay=function(a,b){var c=f.call(arguments,2);return setTimeout(function(){return a.apply(a,c)},b)},u.defer=function(a){return u.delay.apply(u,[a,1].concat(f.call(arguments,1)))};var x=function(a,b,c){var d;return function(){var e=this,f=arguments,g=function(){d=null,a.apply(e,f)};c&&clearTimeout(d);if(c||!d)d=setTimeout(g,b)}};u.throttle=function(a,b){return x(a,b,!1)},u.debounce=function(a,b){return x(a,b,!0)},u.wrap=function(a,b){return function(){var c=[a].concat(f.call(arguments));return b.apply(this,c)}},u.compose=function(){var a=f.call(arguments);return function(){var b=f.call(arguments);for(var c=a.length-1;c>=0;c--)b=[a[c].apply(this,b)];return b[0]}},u.keys=t||function(a){if(u.isArray(a))return u.range(0,a.length);var b=[];for(var c in a)i.call(a,c)&&(b[b.length]=c);return b},u.values=function(a){return u.map(a,u.identity)},u.functions=u.methods=function(a){return u.filter(u.keys(a),function(b){return u.isFunction(a[b])}).sort()},u.extend=function(a){v(f.call(arguments,1),function(b){for(var c in b)a[c]=b[c]});return a},u.clone=function(a){return u.isArray(a)?a.slice():u.extend({},a)},u.tap=function(a,b){b(a);return a},u.isEqual=function(a,b){if(a===b)return!0;var c=typeof a,d=typeof b;if(c!=d)return!1;if(a==b)return!0;if(!a&&b||a&&!b)return!1;a._chain&&(a=a._wrapped),b._chain&&(b=b._wrapped);if(a.isEqual)return a.isEqual(b);if(u.isDate(a)&&u.isDate(b))return a.getTime()===b.getTime();if(u.isNaN(a)&&u.isNaN(b))return!1;if(u.isRegExp(a)&&u.isRegExp(b))return a.source===b.source&&a.global===b.global&&a.ignoreCase===b.ignoreCase&&a.multiline===b.multiline;if(c!=="object")return!1;if(a.length&&a.length!==b.length)return!1;var e=u.keys(a),f=u.keys(b);if(e.length!=f.length)return!1;for(var g in a)if(!(g in b)||!u.isEqual(a[g],b[g]))return!1;return!0},u.isEmpty=function(a){if(u.isArray(a)||u.isString(a))return a.length===0;for(var b in a)if(i.call(a,b))return!1;return!0},u.isElement=function(a){return!!a&&a.nodeType==1},u.isArray=s||function(a){return h.call(a)==="[object Array]"},u.isArguments=function(a){return!!a&&!!i.call(a,"callee")},u.isFunction=function(a){return!!(a&&a.constructor&&a.call&&a.apply)},u.isString=function(a){return!!(a===""||a&&a.charCodeAt&&a.substr)},u.isNumber=function(a){return!!(a===0||a&&a.toExponential&&a.toFixed)},u.isNaN=function(a){return a!==a},u.isBoolean=function(a){return a===!0||a===!1},u.isDate=function(a){return!!(a&&a.getTimezoneOffset&&a.setUTCFullYear)},u.isRegExp=function(a){return!(!(a&&a.test&&a.exec)||!a.ignoreCase&&a.ignoreCase!==!1)},u.isNull=function(a){return a===null},u.isUndefined=function(a){return a===void 0},u.noConflict=function(){a._=b;return this},u.identity=function(a){return a},u.times=function(a,b,c){for(var d=0;d<a;d++)b.call(c,d)},u.mixin=function(a){v(u.functions(a),function(b){B(b,u[b]=a[b])})};var y=0;u.uniqueId=function(a){var b=y++;return a?a+b:b},u.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g},u.template=function(a,b){var c=u.templateSettings,d="var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+a.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(c.interpolate,function(a,b){return"',"+b.replace(/\\'/g,"'")+",'"}).replace(c.evaluate||null,function(a,b){return"');"+b.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+"__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');",e=new Function("obj",d);return b?e(b):e};var z=function(a){this._wrapped=a};u.prototype=z.prototype;var A=function(a,b){return b?u(a).chain():a},B=function(a,b){z.prototype[a]=function(){var a=f.call(arguments);g.call(a,this._wrapped);return A(b.apply(u,a),this._chain)}};u.mixin(u),v(["pop","push","reverse","shift","sort","splice","unshift"],function(a){var b=d[a];z.prototype[a]=function(){b.apply(this._wrapped,arguments);return A(this._wrapped,this._chain)}}),v(["concat","join","slice"],function(a){var b=d[a];z.prototype[a]=function(){return A(b.apply(this._wrapped,arguments),this._chain)}}),z.prototype.chain=function(){this._chain=!0;return this},z.prototype.value=function(){return this._wrapped}})(),function(){var a;typeof exports!="undefined"?a=exports:a=this.Backbone={},a.VERSION="0.3.3";var b=this._;!b&&typeof require!="undefined"&&(b=require("underscore")._);var c=this.jQuery||this.Zepto;a.emulateHTTP=!1,a.emulateJSON=!1,a.Events={bind:function(a,b){var c=this._callbacks||(this._callbacks={}),d=this._callbacks[a]||(this._callbacks[a]=[]);d.push(b);return this},unbind:function(a,b){var c;if(!a)this._callbacks={};else if(c=this._callbacks)if(!b)c[a]=[];else{var d=c[a];if(!d)return this;for(var e=0,f=d.length;e<f;e++)if(b===d[e]){d.splice(e,1);break}}return this},trigger:function(a){var b,c,d,e;if(!(c=this._callbacks))return this;if(b=c[a])for(d=0,e=b.length;d<e;d++)b[d].apply(this,Array.prototype.slice.call(arguments,1));if(b=c.all)for(d=0,e=b.length;d<e;d++)b[d].apply(this,arguments);return this}},a.Model=function(a,c){a||(a={}),this.defaults&&(a=b.extend({},this.defaults,a)),this.attributes={},this._escapedAttributes={},this.cid=b.uniqueId("c"),this.set(a,{silent:!0}),this._previousAttributes=b.clone(this.attributes),c&&c.collection&&(this.collection=c.collection),this.initialize(a,c)},b.extend(a.Model.prototype,a.Events,{_previousAttributes:null,_changed:!1,initialize:function(){},toJSON:function(){return b.clone(this.attributes)},get:function(a){return this.attributes[a]},escape:function(a){var b;if(b=this._escapedAttributes[a])return b;var c=this.attributes[a];return this._escapedAttributes[a]=p(c==null?"":c)},set:function(a,c){c||(c={});if(!a)return this;a.attributes&&(a=a.attributes);var d=this.attributes,e=this._escapedAttributes;if(!c.silent&&this.validate&&!this._performValidation(a,c))return!1;"id"in a&&(this.id=a.id);for(var f in a){var g=a[f];b.isEqual(d[f],g)||(d[f]=g,delete e[f],c.silent||(this._changed=!0,this.trigger("change:"+f,this,g,c)))}!c.silent&&this._changed&&this.change(c);return this},unset:function(a,b){b||(b={});var c=this.attributes[a],d={};d[a]=void 0;if(!b.silent&&this.validate&&!this._performValidation(d,b))return!1;delete this.attributes[a],delete this._escapedAttributes[a],b.silent||(this._changed=!0,this.trigger("change:"+a,this,void 0,b),this.change(b));return this},clear:function(a){a||(a={});var b=this.attributes,c={};for(attr in b)c[attr]=void 0;if(!a.silent&&this.validate&&!this._performValidation(c,a))return!1;this.attributes={},this._escapedAttributes={};if(!a.silent){this._changed=!0;for(attr in b)this.trigger("change:"+attr,this,void 0,a);this.change(a)}return this},fetch:function(b){b||(b={});var c=this,d=function(a){if(!c.set(c.parse(a),b))return!1;b.success&&b.success(c,a)},e=o(b.error,c,b);(this.sync||a.sync)("read",this,d,e);return this},save:function(b,c){c||(c={});if(b&&!this.set(b,c))return!1;var d=this,e=function(a){if(!d.set(d.parse(a),c))return!1;c.success&&c.success(d,a)},f=o(c.error,d,c),g=this.isNew()?"create":"update";(this.sync||a.sync)(g,this,e,f);return this},destroy:function(b){b||(b={});var c=this,d=function(a){c.collection&&c.collection.remove(c),b.success&&b.success(c,a)},e=o(b.error,c,b);(this.sync||a.sync)("delete",this,d,e);return this},url:function(){var a=n(this.collection);if(this.isNew())return a;return a+(a.charAt(a.length-1)=="/"?"":"/")+this.id},parse:function(a){return a},clone:function(){return new this.constructor(this)},isNew:function(){return!this.id},change:function(a){this.trigger("change",this,a),this._previousAttributes=b.clone(this.attributes),this._changed=!1},hasChanged:function(a){if(a)return this._previousAttributes[a]!=this.attributes[a];return this._changed},changedAttributes:function(a){a||(a=this.attributes);var c=this._previousAttributes,d=!1;for(var e in a)b.isEqual(c[e],a[e])||(d=d||{},d[e]=a[e]);return d},previous:function(a){if(!a||!this._previousAttributes)return null;return this._previousAttributes[a]},previousAttributes:function(){return b.clone(this._previousAttributes)},_performValidation:function(a,b){var c=this.validate(a);if(c){b.error?b.error(this,c):this.trigger("error",this,c,b);return!1}return!0}}),a.Collection=function(a,c){c||(c={}),c.comparator&&(this.comparator=c.comparator,delete c.comparator),this._boundOnModelEvent=b.bind(this._onModelEvent,this),this._reset(),a&&this.refresh(a,{silent:!0}),this.initialize(a,c)},b.extend(a.Collection.prototype,a.Events,{model:a.Model,initialize:function(){},toJSON:function(){return this.map(function(a){return a.toJSON()})},add:function(a,c){if(b.isArray(a))for(var d=0,e=a.length;d<e;d++)this._add(a[d],c);else this._add(a,c);return this},remove:function(a,c){if(b.isArray(a))for(var d=0,e=a.length;d<e;d++)this._remove(a[d],c);else this._remove(a,c);return this},get:function(a){if(a==null)return null;return this._byId[a.id!=null?a.id:a]},getByCid:function(a){return a&&this._byCid[a.cid||a]},at:function(a){return this.models[a]},sort:function(a){a||(a={});if(!this.comparator)throw new Error("Cannot sort a set without a comparator");this.models=this.sortBy(this.comparator),a.silent||this.trigger("refresh",this,a);return this},pluck:function(a){return b.map(this.models,function(b){return b.get(a)})},refresh:function(a,b){a||(a=[]),b||(b={}),this._reset(),this.add(a,{silent:!0}),b.silent||this.trigger("refresh",this,b);return this},fetch:function(b){b||(b={});var c=this,d=function(a){c.refresh(c.parse(a)),b.success&&b.success(c,a)},e=o(b.error,c,b);(this.sync||a.sync)("read",this,d,e);return this},create:function(b,c){var d=this;c||(c={}),b instanceof a.Model?b.collection=d:b=new this.model(b,{collection:d});var e=function(a,b){d.add(a),c.success&&c.success(a,b)};return b.save(null,{success:e,error:c.error})},parse:function(a){return a},chain:function(){return b(this.models).chain()},_reset:function(a){this.length=0,this.models=[],this._byId={},this._byCid={}},_add:function(b,c){c||(c={}),b instanceof a.Model||(b=new this.model(b,{collection:this}));var d=this.getByCid(b);if(d)throw new Error(["Can't add the same model to a set twice",d.id]);this._byId[b.id]=b,this._byCid[b.cid]=b,b.collection=this;var e=this.comparator?this.sortedIndex(b,this.comparator):this.length;this.models.splice(e,0,b),b.bind("all",this._boundOnModelEvent),this.length++,c.silent||b.trigger("add",b,this,c);return b},_remove:function(a,b){b||(b={}),a=this.getByCid(a)||this.get(a);if(!a)return null;delete this._byId[a.id],delete this._byCid[a.cid],delete a.collection,this.models.splice(this.indexOf(a),1),this.length--,b.silent||a.trigger("remove",a,this,b),a.unbind("all",this._boundOnModelEvent);return a},_onModelEvent:function(a,b){a==="change:id"&&(delete this._byId[b.previous("id")],this._byId[b.id]=b),this.trigger.apply(this,arguments)}});var d=["forEach","each","map","reduce","reduceRight","find","detect","filter","select","reject","every","all","some","any","include","invoke","max","min","sortBy","sortedIndex","toArray","size","first","rest","last","without","indexOf","lastIndexOf","isEmpty"];b.each(d,function(c){a.Collection.prototype[c]=function(){return b[c].apply(b,[this.models].concat(b.toArray(arguments)))}}),a.Controller=function(a){a||(a={}),a.routes&&(this.routes=a.routes),this._bindRoutes(),this.initialize(a)};var e=/:([\w\d]+)/g,f=/\*([\w\d]+)/g;b.extend(a.Controller.prototype,a.Events,{initialize:function(){},route:function(c,d,e){a.history||(a.history=new a.History),b.isRegExp(c)||(c=this._routeToRegExp(c)),a.history.route(c,b.bind(function(a){var b=this._extractParameters(c,a);e.apply(this,b),this.trigger.apply(this,["route:"+d].concat(b))},this))},saveLocation:function(b){a.history.saveLocation(b)},_bindRoutes:function(){if(!!this.routes)for(var a in this.routes){var b=this.routes[a];this.route(a,b,this[b])}},_routeToRegExp:function(a){a=a.replace(e,"([^/]*)").replace(f,"(.*?)");return new RegExp("^"+a+"$")},_extractParameters:function(a,b){return a.exec(b).slice(1)}}),a.History=function(){this.handlers=[],this.fragment=this.getFragment(),b.bindAll(this,"checkUrl")};var g=/^#*/;b.extend(a.History.prototype,{interval:50,getFragment:function(a){return(a||window.location).hash.replace(g,"")},start:function(){var a=document.documentMode,b=c.browser.msie&&(!a||a<=7);b&&(this.iframe=c('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow),"onhashchange"in window&&!b?c(window).bind("hashchange",this.checkUrl):setInterval(this.checkUrl,this.interval);return this.loadUrl()},route:function(a,b){this.handlers.push({route:a,callback:b})},checkUrl:function(){var a=this.getFragment();a==this.fragment&&this.iframe&&(a=this.getFragment(this.iframe.location));if(a==this.fragment||a==decodeURIComponent(this.fragment))return!1;this.iframe&&(window.location.hash=this.iframe.location.hash=a),this.loadUrl()},loadUrl:function(){var a=this.fragment=this.getFragment(),c=b.any(this.handlers,function(b){if(b.route.test(a)){b.callback(a);return!0}});return c},saveLocation:function(a){a=(a||"").replace(g,"");this.fragment!=a&&(window.location.hash=this.fragment=a,this.iframe&&a!=this.getFragment(this.iframe.location)&&(this.iframe.document.open().close(),this.iframe.location.hash=a))}}),a.View=function(a){this._configure(a||{}),this._ensureElement(),this.delegateEvents(),this.initialize(a)};var h=function(a){return c(a,this.el)},i=/^(\w+)\s*(.*)$/;b.extend(a.View.prototype,a.Events,{tagName:"div",$:h,initialize:function(){},render:function(){return this},remove:function(){c(this.el).remove();return this},make:function(a,b,d){var e=document.createElement(a);b&&c(e).attr(b),d&&c(e).html(d);return e},delegateEvents:function(a){if(!!a||!!(a=this.events)){c(this.el).unbind();for(var d in a){var e=a[d],f=d.match(i),g=f[1],h=f[2],j=b.bind(this[e],this);h===""?c(this.el).bind(g,j):c(this.el).delegate(h,g,j)}}},_configure:function(a){this.options&&(a=b.extend({},this.options,a)),a.model&&(this.model=a.model),a.collection&&(this.collection=a.collection),a.el&&(this.el=a.el),a.id&&(this.id=a.id),a.className&&(this.className=a.className),a.tagName&&(this.tagName=a.tagName),this.options=a},_ensureElement:function(){if(!this.el){var a={};this.id&&(a.id=this.id),this.className&&(a["class"]=this.className),this.el=this.make(this.tagName,a)}}});var j=function(a,b){var c=m(this,a,b);c.extend=j;return c};a.Model.extend=a.Collection.extend=a.Controller.extend=a.View.extend=j;var k={create:"POST",update:"PUT","delete":"DELETE",read:"GET"};a.sync=function(b,d,e,f){var g=k[b],h=b==="create"||b==="update"?JSON.stringify(d.toJSON()):null,i={url:n(d),type:g,contentType:"application/json",data:h,dataType:"json",processData:!1,success:e,error:f};a.emulateJSON&&(i.contentType="application/x-www-form-urlencoded",i.processData=!0,i.data=h?{model:h}:{}),a.emulateHTTP&&(g==="PUT"||g==="DELETE")&&(a.emulateJSON&&(i.data._method=g),i.type="POST",i.beforeSend=function(a){a.setRequestHeader("X-HTTP-Method-Override",g)}),c.ajax(i)};var l=function(){},m=function(a,c,d){var e;c&&c.hasOwnProperty("constructor")?e=c.constructor:e=function(){return a.apply(this,arguments)},l.prototype=a.prototype,e.prototype=new l,c&&b.extend(e.prototype,c),d&&b.extend(e,d),e.prototype.constructor=e,e.__super__=a.prototype;return e},n=function(a){if(!a||!a.url)throw new Error("A 'url' property or function must be specified");return b.isFunction(a.url)?a.url():a.url},o=function(a,b,c){return function(d){a?a(b,d):b.trigger("error",b,d,c)}},p=function(a){return a.replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}}();var Store=function(a){this.name=a;var b=localStorage.getItem(this.name);this.data=b&&JSON.parse(b)||{}};_.extend(Store.prototype,{save:function(){localStorage.setItem(this.name,JSON.stringify(this.data))},create:function(a){a.id||(a.id=a.attributes.id=guid()),this.data[a.id]=a,this.save();return a},update:function(a){this.data[a.id]=a,this.save();return a},find:function(a){return this.data[a.id]},findAll:function(){return _.values(this.data)},destroy:function(a){delete this.data[a.id],this.save();return a}}),Backbone.sync=function(a,b,c,d){var e,f=b.localStorage||b.collection.localStorage;switch(a){case"read":e=b.id?f.find(b):f.findAll();break;case"create":e=f.create(b);break;case"update":e=f.update(b);break;case"delete":e=f.destroy(b)}e?c(e):d("Record not found")},function(){this.Composition=Backbone.Model.extend({defaults:{title:"untitled composition",description:"mixed with sembiki meemoo audio visual sequencer",mixer:"me!"},initialize:function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I;this.get("loadJSON")!==void 0&&(i=this.get("loadJSON"),i!==""&&(b=JSON.parse(i),b.id&&(this.attributes.parent_id=b.id),b.bpm&&(this.attributes.bpm=b.bpm),b.description&&(this.attributes.description="Forked from "+b.title+" by "+b.mixer+" --- "+b.description),b.mixer&&(this.attributes.mixer=b.mixer),b.patterns&&(this.attributes.patterns=b.patterns),b.players&&(this.attributes.players=b.players),b.title&&(this.attributes.title="Re: "+b.title),b.sequences&&(this.attributes.sequences=b.sequences),b.videos&&(this.attributes.videos=b.videos))),this.Videos=new VideoList,this.Players=new PlayerList;if(this.attributes.players){C=this.attributes.players;for(o=0,s=C.length;o<s;o++){k=C[o],D=this.attributes.videos;for(p=0,t=D.length;p<t;p++){n=D[p];if(k.video_id===n.id){a=n.ytid,a!==""&&(d=this.addPlayer(a),d.Video.Triggers=n.triggers,k.newcid=d.cid);break}}}}this.Patterns=new PatternList;if(this.attributes.patterns){E=this.attributes.patterns;for(q=0,u=E.length;q<u;q++){j=E[q],c=new Pattern({Composition:this,trigger_id:j.trigger_id,next:j.next,chance:j.chance,beats:j.beats}),this.Patterns.add(c),j.newcid=c.cid;if(j.tracks){F=j.tracks;for(r=0,v=F.length;r<v;r++){m=F[r],h=m.player_id,G=this.attributes.players;for(z=0,w=G.length;z<w;z++){k=G[z];if(h===k.id){g=c.addTrack(this.Players.getByCid(k.newcid)),g.setLine(m.line);break}}}}}}this.Pattern=null,this.nextPattern=null,this.playing=!1,this.Sequences=new SequenceList;if(this.attributes.sequences){H=this.attributes.sequences;for(A=0,x=H.length;A<x;A++){l=H[A],e=new Sequence({Composition:this,length:l.length}),this.Sequences.add(e);if(l.tracks){I=l.tracks;for(B=0,y=I.length;B<y;B++)m=I[B],m.line.length>0&&(f=e.addTrack(),f.setLine(m.line))}}}this.attributes.bpm?this.setBpm(this.attributes.bpm):this.setBpm(120);return this.ListView=new CompositionListView({model:this})},setBpm:function(a){if(0<a&&a<500){this.set({bpm:a}),this.bpm=a;return this.bpm_ms=Math.round(1e3/this.bpm*60)}},play:function(){clearTimeout(App.timer),App.timer=setTimeout("App.Composition.step()",this.bpm_ms);return this.playing=!0},stop:function(){clearTimeout(App.timer);return this.playing=!1},step:function(){try{this.Pattern.step();return this.play()}catch(a){}},cuePattern:function(a){this.nextPattern=a;if(this.playing===!1){this.Pattern=a,this.nextPattern=null;return this.play()}},cueSequence:function(a){this.nextSequence=a;if(this.playing===!1){this.Sequence=a,this.nextSequence=null,this.loop();return this.play()}},playSequence:function(a){this.Sequence=a,this.nextPattern=null,this.loop();return this.play()},stopSequence:function(a){if(this.Sequence===a)return this.Sequence=null},loop:function(){var a,b,c,d,e,f,g,h,i,j,k,l;if(this.nextPattern!==null)this.Pattern=this.nextPattern,this.nextPattern=null,this.Sequence=null;else{this.nextSequence!==null&&(this.Sequence=this.nextSequence,this.nextSequence=null),c=null,this.Sequence!==null&&(c=this.Sequence.step()),c===null&&this.Pattern!==null&&(c=this.Pattern.get("next")),f=0,b=[],k=this.Patterns.models;for(g=0,i=k.length;g<i;g++)d=k[g],d.get("trigger_id")===c&&(f+=d.get("chance"),b.push(d));if(b.length===1)return this.Pattern=b[0];if(b.length>1){e=Math.random()*f,l=[];for(h=0,j=b.length;h<j;h++){a=b[h];if(e<a.get("chance")){this.Pattern=a;return}l.push(e-=a.get("chance"))}return l}}},multitrigger:function(a){var b,c,d,e,f;c="";for(e=0,f=a.length;e<f;e++)b=a[e],d=b.player.Video.Triggers[b.trigger],d!==null&&d!==void 0&&(c+="seek:",c+=""+b.player.cid+":",c+=""+d+"|");if(c!=="")return App.postRawMessageToViewer(c)},initializeView:function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p;this.View=new CompositionView({model:this}),m=this.Players.models;for(e=0,i=m.length;e<i;e++)b=m[e],b.initializeView();n=this.Videos.models;for(f=0,j=n.length;f<j;f++)d=n[f],d.initializeView();o=this.Patterns.models;for(g=0,k=o.length;g<k;g++)a=o[g],a.initializeView();p=this.Sequences.models;for(h=0,l=p.length;h<l;h++)c=p[h],c.initializeView();return App.reloadVideos()},addPlayer:function(a){var b;b=new Player({Composition:this,ytid:a}),this.Players.add(b);return b},addPattern:function(){var a,b;b=this.Patterns.models.length,a=new Pattern({Composition:this,trigger_id:b,next:b}),this.Patterns.add(a),a.addTracks();return a},addSequence:function(){var a;a=new Sequence({Composition:this}),this.Sequences.add(a),a.addTrack();return a},toJSON:function(){var a;return a={id:this.id,title:this.get("title"),description:this.get("description"),mixer:this.get("mixer"),bpm:this.get("bpm"),videos:this.Videos,players:this.Players,patterns:this.Patterns,sequences:this.Sequences,parent_id:this.get("parent_id")}},"delete":function(){this.destroy(),this.ListView.remove();try{return this.View.remove()}catch(a){}}}),this.CompositionList=Backbone.Collection.extend({model:Composition,localStorage:new Store("compositions")}),this.CompositionListView=Backbone.View.extend({tagName:"div",className:"composition-list",template:_.template($("#composition-list-template").html()),events:{"click .comp_load_button":"load","click .comp_export_button":"export","click .comp_delete_button":"delete"},render:function(){$(this.el).html(this.template(this.model.toJSON())),this.$(".comp_load_button").button({icons:{primary:"ui-icon-folder-open"}}),this.$(".comp_export_button").button({icons:{primary:"ui-icon-clipboard"}}),this.$(".comp_delete_button").button({icons:{primary:"ui-icon-trash"}});return this},initialize:function(){this.render();return $("#comp_dialog").append($(this.el))},save:function(){return this.render()},load:function(){App.loadComposition(this.model);return $("comp_dialog").dialog("close")},"export":function(){$("#comp_export_dialog textarea").text(JSON.stringify(this.model));return $("#comp_export_dialog").dialog({modal:!0,width:400,height:300})},"delete":function(){if(confirm("Are you sure you want to remove this composition ("+this.model.get("title")+")?"))return this.model["delete"]()},remove:function(){return $(this.el).remove()}}),this.CompositionView=Backbone.View.extend({tagName:"div",className:"composition",template:_.template($("#composition-template").html()),events:{"click .composition-save-button":"save","click .composition-export-button":"export","mouseover .navigable":"mouseoverNavigable","keydown .automulti":"automulti","keydown .automulti2":"automulti2","click .add-pattern":"addPattern","click .add-player":"addPlayer","click .add-sequence":"addSequence","click .play-all-button":"playAll","click .pause-all-button":"pauseAll"},render:function(){$(this.el).html(this.template(this.model.toJSON())),this.$(".composition-save-button").button({icons:{primary:"ui-icon-disk"}}),this.$(".composition-export-button").button({icons:{primary:"ui-icon-clipboard"}}),this.$(".automulti").button({icons:{primary:"ui-icon-battery-1"}}),this.$(".automulti2").button({icons:{primary:"ui-icon-battery-3"}}),this.$(".add-player").button({icons:{primary:"ui-icon-plus"}}),this.$(".add-pattern").button({icons:{primary:"ui-icon-plus"}}),this.$(".add-sequence").button({icons:{primary:"ui-icon-plus"}}),this.$(".play-all-button").button({icons:{primary:"ui-icon-play"}}),this.$(".pause-all-button").button({icons:{primary:"ui-icon-pause"}});return this.$(".patterns-tabs").tabs()},initialize:function(){this.render();return $("#setup").append($(this.el))},mouseoverNavigable:function(a){return $(a.currentTarget).focus()},addPlayer:function(){var a;a=this.$(".addplayerid").val();if(a!=="")return this.model.addPlayer(a)},addPattern:function(){var a;a=this.model.addPattern();return a.initializeView()},addSequence:function(){var a;a=this.model.addSequence();return a.initializeView()},automulti:function(a){var b,c;c=App.keycodes.indexOf(a.keyCode);if(c!==-1){b=Math.floor(c/10);if(this.model.Players.models[b])return this.model.Players.models[b].View.trigger(c%10)}},automulti2:function(a){var b,c,d,e,f,g,h;d=App.keycodes.indexOf(a.keyCode);if(d!==-1){e=[],h=this.model.Players.models;for(f=0,g=h.length;f<g;f++)b=h[f],c={},c.player=b,c.trigger=d,e.push(c);return this.model.multitrigger(e)}},playAll:function(){var a,b,c,d,e;d=this.model.Players.models,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(a.View.play());return e},pauseAll:function(){var a,b,c,d,e;d=this.model.Players.models,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(a.View.pause());return e},save:function(){this.model.save({title:$.trim(this.$(".comp_info_title").text()),mixer:$.trim(this.$(".comp_info_mixer").text()),description:$.trim(this.$(".comp_info_description").text()),bpm:parseInt(this.$(".comp_info_bpm").val())}),this.model.setBpm(parseInt(this.$(".comp_info_bpm").val()));return this.model.ListView.render()},"export":function(){return this.model.ListView["export"]()},"delete":function(){if(confirm("Are you sure you want to remove this composition ("+this.model.get("title")+")?"))return this.model["delete"]()},remove:function(){var a,b,c,d;this.model.stop(),d=this.model.Players.models;for(b=0,c=d.length;b<c;b++)a=d[b],App.postMessageToViewer("remove",a.cid);return $(this.el).empty().remove()}})}.call(this),function(){this.Video=Backbone.Model.extend({initialize:function(){this.Triggers=[];return this.addTrigger(0,0)},initializeView:function(){return this.View=new VideoView({model:this})},addTrigger:function(a,b){if(a<App.triggers.length){b=parseFloat(b);if(this.Triggers.indexOf(b)===-1)return this.Triggers[a]=b}},change:function(){if(this.View)return this.View.updateTriggers()},toJSON:function(){var a;return a={id:this.cid,ytid:this.get("ytid"),triggers:this.Triggers}}}),this.VideoList=Backbone.Collection.extend({model:Video,getOrAddVideo:function(a){var b,c,d,e,f;f=this.models;for(d=0,e=f.length;d<e;d++){c=f[d];if(a===c.get("ytid"))return c}b=new Video({ytid:a}),this.add(b);return b}}),this.VideoView=Backbone.View.extend({tagName:"div",className:"video",render:function(){return this},initialize:function(){return this.updateTriggers()},updateTriggers:function(){var a,b,c,d,e,f;c="",f=this.model.Triggers;for(d=0,e=f.length;d<e;d++)b=f[d],b!==null&&b>=0&&this.model.get("totaltime")>0&&(a=b/this.model.get("totaltime")*100,c+="<span class='showtrigger v_"+this.model.cid+"_t_"+d+"' style='left:"+a+"%;'>"+App.triggers[d]+"</span>");return $(".showtriggers_"+this.model.cid).html(c)}})}.call(this),function(
){this.Player=Backbone.Model.extend({initialize:function(){this.get("ytid")&&(this.Video=this.get("Composition").Videos.getOrAddVideo(this.get("ytid")));if(this.get("Composition")===App.Composition){this.initializeView();return this.Video.initializeView()}},initializeView:function(){this.View=new PlayerView({model:this});return this.set({playing:!0})},remove:function(){return App.Composition.Players.remove(this)},change:function(){return this.View.updateinfo()},toJSON:function(){var a;return a={id:this.cid,video_id:this.Video.cid}}}),this.PlayerList=Backbone.Collection.extend({model:Player}),this.PlayerView=Backbone.View.extend({tagName:"div",className:"control",template:_.template($("#control-template").html()),lastTrigger:0,events:{"click .playbutton":"play","click .pausebutton":"pause","click .mutebutton":"mute","click .unmutebutton":"unmute","slide .volumeslider":"volume","click .addtriggerbutton":"addtrigger","click .removebutton":"remove","mouseover .playprogress":"playprogressOver","click .playprogress":"playprogressClick","keydown .playprogress":"playprogressKey"},playpause:function(){return this.model.get("playing")?this.pause():this.play()},play:function(){this.model.set({playing:!0}),window.App.postMessageToViewer("play",this.model.cid);return this.model.Video.View.updateTriggers()},pause:function(){this.model.set({playing:!1}),window.App.postMessageToViewer("pause",this.model.cid);return this.model.Video.View.updateTriggers()},mute:function(){return window.App.postMessageToViewer("mute",this.model.cid)},unmute:function(){return window.App.postMessageToViewer("unmute",this.model.cid)},volume:function(a,b){return window.App.postMessageToViewer("volume",this.model.cid,b.value)},remove:function(){if(confirm("Are you sure you want to remove this player ("+this.model.cid+")?")){window.App.postMessageToViewer("remove",this.model.cid),$(this.el).remove();return this.model.remove()}},addtrigger:function(){var a,b,c,d,e,f,g,h;if(this.model.get("totaltime")>0){c=0,g=this.model.Video.Triggers;for(e=0,f=g.length;e<f;e++)d=g[e],d>c&&(c=Math.ceil(d));a=this.model.Video.Triggers.length,h=[];for(b=0;b<=8;b++)h.push(this.model.Video.addTrigger(a+b,c+(b+1)*2));return h}},playprogressOver:function(a){return $(a.currentTarget).focus()},playprogressClick:function(a){var b;b=(a.layerX-5)/$(a.currentTarget).width();return this.seek(b*this.model.get("totaltime"))},seek:function(a){return window.App.postMessageToViewer("seek",this.model.cid,a)},focusPrev:function(){this.$(".playprogress").parent().prev().children(".playprogress").focus();return!1},focusNext:function(){this.$(".playprogress").parent().next().children(".playprogress").focus();return!1},playprogressKey:function(a){switch(a.keyCode){case 32:return this.playpause();case 38:return this.focusPrev();case 40:return this.focusNext();case 37:return this.triggerArp(!0);case 39:return this.triggerArp(!1);default:return this.triggerCode(a.keyCode)}},triggerCode:function(a){var b;b=App.keycodes.indexOf(a);if(b!==-1)return this.triggerOrAdd(b)},triggerOrAdd:function(a){var b;b=this.model.Video.Triggers[a];if(b===void 0||b===null)return this.model.Video.addTrigger(a,this.model.get("time"));this.lastTrigger=a;return this.seek(b)},trigger:function(a){var b;b=this.model.Video.Triggers[a];if(b!==void 0&&b!==null){this.lastTrigger=a;return this.seek(b)}},triggerArp:function(a){var b,c;b=this.lastTrigger,c=null;if(a){while(b>0&&(c===null||c===void 0))b--,c=this.model.Video.Triggers[b];b===0&&(c=0)}else while(b<this.model.Video.Triggers.length-1&&(c===null||c===void 0))b++,c=this.model.Video.Triggers[b];if(c!==void 0&&c!==null){this.lastTrigger=b;return this.seek(c)}},render:function(){$(this.el).html(this.template(this.model.toJSON()));return this},updateinfo:function(){if(this.model.get("totalsize")>0){this.$(".statusmessage").html(""+this.model.get("time")+" / "+this.model.get("totaltime")+" <br /> "+this.model.get("loaded")+" / "+this.model.get("totalsize")),this.$(".playprogress").progressbar("value",this.model.get("time")/this.model.get("totaltime")*100);return this.$(".loadprogress").progressbar("value",this.model.get("loaded")/this.model.get("totalsize")*100)}},initialize:function(){window.App.postMessageToViewer("create",this.model.cid,this.model.get("ytid")),this.render(),this.model.get("Composition").View.$(".players").append($(this.el)),this.$(".playbutton").button({icons:{primary:"ui-icon-play"},text:!1}),this.$(".pausebutton").button({icons:{primary:"ui-icon-pause"},text:!1}),this.$(".mutebutton").button({icons:{primary:"ui-icon-volume-off"},text:!1}),this.$(".unmutebutton").button({icons:{primary:"ui-icon-volume-on"},text:!1}),this.$(".volumeslider").slider({value:100,min:0,max:100}),this.$(".addtriggerbutton").button({icons:{primary:"ui-icon-plus"},text:!1}),this.$(".removebutton").button({icons:{primary:"ui-icon-trash"},text:!1}),this.$(".playprogress").progressbar({value:0}),this.$(".loadprogress").progressbar({value:0});return this}})}.call(this),function(){this.Pattern=Backbone.Model.extend({defaults:{trigger_id:0,chance:1,beats:16,next:0},initialize:function(){this.Tracks=new TrackList;return this.beat=0},initializeView:function(){var a,b,c,d,e;this.View=new PatternView({model:this,id:"pattern_"+this.cid}),d=this.Tracks.models,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(a.initializeView());return e},addTracks:function(){var a,b,c,d,e;d=this.get("Composition").Players.models,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(this.addTrack(a));return e},addTrack:function(a){var b;b=new Track({Pattern:this,Player:a}),this.Tracks.add(b);return b},toJSON:function(){var a;return a={id:this.cid,trigger_id:parseInt(this.get("trigger_id")),chance:parseInt(this.get("chance")),next:parseInt(this.get("next")),beats:parseInt(this.get("beats")),tracks:this.Tracks}},play:function(){this.get("Composition").cuePattern(this);return this.beat=0},stop:function(){this.get("Composition").stop();return this.beat=0},step:function(){var a,b,c,d,e,f,g;this.beat===0&&this.View.startPlaying(),d=[],g=this.Tracks.models;for(e=0,f=g.length;e<f;e++)b=g[e],c=b.Line[this.beat],c!==null&&c!==void 0&&(a={},a.player=b.get("Player"),a.trigger=c,d.push(a));this.get("Composition").multitrigger(d),this.View.step(),this.beat++;if(this.beat>=this.get("beats")){this.beat=0;return this.get("Composition").loop()}},"delete":function(){this.destroy();return this.View.remove()}}),this.PatternList=Backbone.Collection.extend({model:Pattern}),this.PatternView=Backbone.View.extend({tagName:"div",className:"pattern",template:_.template($("#pattern-template").html()),events:{"click .pattern_addtrack_button":"chooseTrack","mouseover .navigable":"mouseoverNavigable","change .pattern_beats":"setBeats","blur .pattern_beats":"setBeats","change .pattern_chance":"setChance","blur .pattern_chance":"setChance","click .pattern_play_button":"play","click .pattern_stop_button":"stop","keydown .pattern_trigger":"setTrigger","keydown .pattern_next":"setNext"},render:function(){$(this.el).html(this.template(this.model.toJSON()));return this},mouseoverNavigable:function(a){return $(a.currentTarget).focus()},setChance:function(a){return this.model.set({chance:parseInt($(a.currentTarget).val())})},setTrigger:function(a){var b;b=App.keycodes.indexOf(a.keyCode);if(b!==-1){this.model.set({trigger_id:b});return $(a.currentTarget).text(App.triggers[b])}},setNext:function(a){var b;b=App.keycodes.indexOf(a.keyCode);if(b!==-1){this.model.set({next:b});return $(a.currentTarget).text(App.triggers[b])}},startPlaying:function(){this.$(".beat").removeClass("cue");return $(".patterns .beat").removeClass("active")},initialize:function(){this.render(),this.$(".pattern_play_button").button({icons:{primary:"ui-icon-play"},text:!1}),this.$(".pattern_stop_button").button({icons:{primary:"ui-icon-stop"},text:!1}),this.$(".pattern_addtrack_button").button({icons:{primary:"ui-icon-plus"}}),this.$(".navigable").attr("tabindex",0);return this.model.get("Composition").View.$(".patterns").append($(this.el))},"delete":function(){if(confirm("Are you sure you want to remove this pattern ("+this.model.get("title")+")?"))return this.model["delete"]()},play:function(){this.model.play(),$(".pattern_trigger").removeClass("cue");return this.$(".pattern_trigger").addClass("cue")},stop:function(){this.model.stop();return this.$(".beat").removeClass("active")},chooseTrack:function(){var a,b,c,d,e,f,g,h,i,j,k;a=$("<div></div>"),$(this.el).append(a),j=App.Composition.Players.models;for(f=0,h=j.length;f<h;f++){c=j[f],b=!1,k=this.model.Tracks.models;for(g=0,i=k.length;g<i;g++)e=k[g],e.get("Player").cid===c.cid&&(b=!0);d=$("<div>"+c.cid+"</div>"),d.data({pattern_id:this.model.cid,player_id:c.cid}).button({disabled:b}).click(function(){var b,c;b=$(this).data("pattern_id"),c=$(this).data("player_id"),App.Composition.Patterns.getByCid(b).View.addTrack(c);return $(a).dialog("close")}),a.append(d)}return a.dialog()},addTrack:function(a){var b;b=this.model.addTrack(App.Composition.Players.getByCid(a));return b.initializeView()},setBeats:function(){var a,b,c,d,e,f;a=this.$(".pattern_beats").val(),this.model.set({beats:a}),e=this.model.Tracks.models,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(b.View.initialize());return f},step:function(){this.$(".beat").removeClass("active");return this.$(".beat_"+this.model.beat).addClass("active")},remove:function(){return $(this.el).remove()}})}.call(this),function(){this.Track=Backbone.Model.extend({initialize:function(){this.Line=[];return this.pattern_id=this.get("Pattern").cid},initializeView:function(){return this.View=new TrackView({model:this,Pattern:this.get("Pattern")})},setLine:function(a){return this.Line=a},addTrigger:function(a,b){return this.Line[a]=b},setBeat:function(a,b){this.Line[a]=b;if(this.View)return this.View.setBeat(a,b)},toJSON:function(){var a;return a={player_id:this.get("Player").cid,line:this.Line}},"delete":function(){this.destroy();return this.View.remove()}}),this.TrackList=Backbone.Collection.extend({model:Track}),this.TrackView=Backbone.View.extend({tagName:"div",className:"track",template:_.template($("#track-template").html()),events:{"keydown .beat":"beatKeydown"},render:function(){$(this.el).html(this.template(this.model.toJSON()));return this},initialize:function(){var a,b,c,d,e;$(this.el).empty(),this.Beats=[],this.render(),b=this.model.get("Pattern").get("beats");for(d=0,e=b-1;0<=e?d<=e:d>=e;0<=e?d+=1:d-=1){c=App.triggers[this.model.Line[d]];if(c===null||c===void 0)c="&nbsp;";a=$("<span class='beat beat_"+d+" navigable'>"+c+"</span>"),a.data("beat",d),$(this.el).append(a),this.Beats[d]=a}this.$(".navigable").attr("tabindex",0);return this.model.get("Pattern").View.$(".pattern_tracks").append($(this.el))},beatKeydown:function(a){var b;b=$(a.currentTarget).data("beat");switch(a.keyCode){case 9:return!0;case 8:return this.focusPrev(b);case 46:return this.focusPrev(b);case 38:return this.focusPrevTrack(b);case 40:return this.focusNextTrack(b);case 37:return this.focusPrev(b);case 39:return this.focusNext(b);default:this.setBeatKeycode(b,a.keyCode);return!1}},setBeatKeycode:function(a,b){var c,d;d=App.keycodes.indexOf(b);if(d===-1)if(b===32||b===8||b===46||b===27)d=null;else return;c=d===null?"&nbsp;":App.triggers[d],this.Beats[a].html(c),this.model.setBeat(a,d);return b!==32&&d===null?this.focusPrev(a):this.focusNext(a)},focusPrev:function(a){var b;(b=this.Beats[a-1])?b.focus():(b=this.Beats[this.Beats.length-1])&&b.focus();return!1},focusNext:function(a){var b;(b=this.Beats[a+1])?b.focus():(b=this.Beats[0])&&b.focus();return!1},focusPrevTrack:function(a){var b;(b=this.Beats[a].parent().prev().children(".beat_"+a))&&b.focus();return!1},focusNextTrack:function(a){var b;(b=this.Beats[a].parent().next().children(".beat_"+a))&&b.focus();return!1},setBeat:function(a,b){var c;c=b===null?"&nbsp;":App.triggers[b];return this.Beats[a].html(c)},"delete":function(){if(confirm("Are you sure you want to remove this pattern ("+this.model.get("title")+")?"))return this.model["delete"]()},remove:function(){return $(this.el).remove()}})}.call(this),function(){this.Sequence=Backbone.Model.extend({defaults:{length:16},initialize:function(){this.Tracks=new SequenceTrackList;return this.beat=-1},initializeView:function(){var a,b,c,d,e;this.View=new SequenceView({model:this}),d=this.Tracks.models,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(a.initializeView());return e},toJSON:function(){var a;return a={id:this.cid,length:parseInt(this.get("length")),tracks:this.Tracks}},"delete":function(){this.destroy();return this.View.remove()},addTrack:function(){var a;a=new SequenceTrack({Sequence:this}),this.Tracks.add(a);return a},cue:function(a){return this.beat=a-1},play:function(){return this.get("Composition").cueSequence(this)},stop:function(){this.beat=-1;return this.get("Composition").stopSequence(this)},step:function(){var a;this.beat++,this.beat>=this.get("length")&&(this.beat=0),this.View.step(),a=this.Tracks.models[0].Line[this.beat],a===void 0&&(a=null);return a}}),this.SequenceList=Backbone.Collection.extend({model:Sequence}),this.SequenceView=Backbone.View.extend({tagName:"div",className:"sequence",template:_.template($("#sequence-template").html()),events:{"mouseover .navigable":"mouseoverNavigable","change .sequence_length":"setLength","blur .sequence_length":"setLength","click .sequence_play_button":"play","click .sequence_stop_button":"stop"},render:function(){$(this.el).html(this.template(this.model.toJSON()));return this},initialize:function(){this.render(),this.$(".sequence_play_button").button({icons:{primary:"ui-icon-play"},text:!1}),this.$(".sequence_stop_button").button({icons:{primary:"ui-icon-stop"},text:!1}),this.$(".navigable").attr("tabindex",0);return this.model.get("Composition").View.$(".sequences").append($(this.el))},mouseoverNavigable:function(a){return $(a.currentTarget).focus()},"delete":function(){if(confirm("Are you sure you want to remove this composition ("+this.model.get("title")+")?"))return this.model["delete"]()},setLength:function(){var a,b,c,d,e,f;a=this.$(".sequence_length").val();if(0<a&&a<1e3){this.model.set({length:a}),e=this.model.Tracks.models,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(b.View.initialize());return f}},remove:function(){return $(this.el).remove()},play:function(){return this.model.play()},stop:function(){this.model.stop();return this.$(".beat").removeClass("active")},step:function(){this.$(".beat").removeClass("cue"),$(".sequencetrack .beat").removeClass("active");return this.$(".beat_"+this.model.beat).addClass("active")}})}.call(this),function(){this.SequenceTrack=Backbone.Model.extend({initialize:function(){return this.Line=[]},initializeView:function(){return this.View=new SequenceTrackView({model:this})},setLine:function(a){return this.Line=a},addTrigger:function(a,b){return this.Line[a]=b},setBeat:function(a,b){this.Line[a]=b;if(this.View)return this.View.setBeat(a,b)},toJSON:function(){var a;return a={line:this.Line}},"delete":function(){this.destroy();return this.View.remove()}}),this.SequenceTrackList=Backbone.Collection.extend({model:Track}),this.SequenceTrackView=Backbone.View.extend({tagName:"div",className:"sequencetrack",template:_.template($("#sequencetrack-template").html()),events:{"keydown .beat":"beatKeydown","click .beat":"cueBeat"},render:function(){$(this.el).html(this.template(this.model.toJSON()));return this},initialize:function(){var a,b,c,d,e;$(this.el).empty(),this.Beats=[],this.render(),d=this.model.get("Sequence").get("length");for(c=0,e=d-1;0<=e?c<=e:c>=e;0<=e?c+=1:c-=1){b=App.triggers[this.model.Line[c]];if(b===null||b===void 0)b="&nbsp;";a=$("<span class='sequencebeat beat beat_"+c+" navigable'>"+b+"</span>"),a.data("beat",c),$(this.el).append(a),this.Beats[c]=a}this.$(".navigable").attr("tabindex",0);return this.model.get("Sequence").View.$(".sequence_tracks").append($(this.el))},cueBeat:function(a){var b,c;this.$(".beat").removeClass("cue"),b=$(a.currentTarget).data("beat"),c=this.Beats[b],c.addClass("cue");return this.model.get("Sequence").cue(b)},beatKeydown:function(a){var b;b=$(a.currentTarget).data("beat");switch(a.keyCode){case 9:return!0;case 8:return this.focusPrev(b);case 46:return this.focusPrev(b);case 38:return this.focusPrevTrack(b);case 40:return this.focusNextTrack(b);case 37:return this.focusPrev(b);case 39:return this.focusNext(b);default:this.setBeatKeycode(b,a.keyCode);return!1}},setBeatKeycode:function(a,b){var c,d;d=App.keycodes.indexOf(b);if(d===-1)if(b===32||b===8||b===46||b===27)d=null;else return;c=d===null?"&nbsp;":App.triggers[d],this.Beats[a].html(c),this.model.setBeat(a,d);return b!==32&&d===null?this.focusPrev(a):this.focusNext(a)},focusPrev:function(a){var b;(b=this.Beats[a-1])?b.focus():(b=this.Beats[this.Beats.length-1])&&b.focus();return!1},focusNext:function(a){var b;(b=this.Beats[a+1])?b.focus():(b=this.Beats[0])&&b.focus();return!1},focusPrevTrack:function(a){var b;(b=this.Beats[a].parent().prev().children(".beat_"+a))&&b.focus();return!1},focusNextTrack:function(a){var b;(b=this.Beats[a].parent().next().children(".beat_"+a))&&b.focus();return!1},setBeat:function(a,b){var c;c=b===null?"&nbsp;":App.triggers[b];return this.Beats[a].html(c)},"delete":function(){if(confirm("Are you sure you want to remove this pattern ("+this.model.get("title")+")?"))return this.model["delete"]()},remove:function(){return $(this.el).remove()}})}.call(this),function(){var a;this.AppView=Backbone.View.extend({template:_.template($("#application-template").html()),triggers_us:["1","2","3","4","5","6","7","8","9","0","q","w","e","r","t","y","u","i","o","p","a","s","d","f","g","h","j","k","l",";","z","x","c","v","b","n","m",",",".","/"],keycodes_us:[49,50,51,52,53,54,55,56,57,48,81,87,69,82,84,89,85,73,79,80,65,83,68,70,71,72,74,75,76,186,90,88,67,86,66,78,77,188,190,191],initialize:function(){$("#intro").hide(),$("#application").html(this.template),this.timer=null,this.triggers=this.triggers_us,this.keycodes=this.keycodes_us,this.viewer=document.getElementById("viewer").contentWindow,$("#popoutbutton").button({icons:{primary:"ui-icon-newwin"}}).click(function(){return App.popoutViewer()}),$("#newcomposition").button({icons:{primary:"ui-icon-document"}}).click(function(){var a;if(confirm("Are you sure you want to start with a new blank composition?")){a=new Composition,App.Compositions.add(a);return App.loadComposition(a)}}),$("#loadcomposition").button({icons:{primary:"ui-icon-folder-open"}}).click(function(){return $("#comp_dialog").dialog({modal:!0,width:400})});return $("#comp_import_button").button({icons:{primary:"ui-icon-arrowthickstop-1-s"}}).click(function(){var a;a=$("#comp_import_text").val().replace(/(\r\n|\n|\r)/gm," ");return App.loadComposition(App.Compositions.create({loadJSON:a}))})},initializeCompositions:function(){var a;this.Compositions=new CompositionList,this.Compositions.fetch();if(this.Compositions.length>0)return this.loadComposition(this.Compositions.at(this.Compositions.length-1));a=new Composition,App.Compositions.add(a);return App.loadComposition(a)},loadComposition:function(a){try{this.Composition.View.remove()}catch(b){}this.Composition=a;return this.Composition.initializeView()},popoutViewer:function(){this.viewer=window.open("viewer.html","popoutviewer"),$("#container").hide(),$("#viewer").remove();return $("#setup").addClass("floatingsetup")},popinViewer:function(){if($("#viewer").length===0){$("#container").prepend('<iframe src="viewer.html" id="viewer" name="inviewer"></iframe>'),this.viewer=document.getElementById("viewer").contentWindow,$("#container").show();return $("#setup").removeClass("floatingsetup")}},reloadVideos:function(){this.reload=function(){var a,b,c,d,e;d=App.Composition.Players.models,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],a.set({loaded:0,time:0}),e.push(App.postMessageToViewer("create",a.cid,a.Video.get("ytid")));return e},this.reloadTriggers=function(){var a,b,c,d,e;d=App.Composition.Videos.models,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(a.View.updateTriggers());return e},setTimeout(this.reload,2e3);return setTimeout(this.reloadTriggers,7e3)},postMessageToViewer:function(a,b,c){return this.postRawMessageToViewer(""+a+":"+b+":"+c)},postRawMessageToViewer:function(a){return this.viewer.postMessage(a,window.location.protocol+"//"+window.location.host)},recieveMessage:function(a){var b,c,d,e,f,g,h,i,j,k,l,m;if(a==="-=POPOUTCLOSED=-")return this.popinViewer();if(a==="-=REFRESH=-")return this.reloadVideos();g=a.split("|"),m=[];for(k=0,l=g.length;k<l;k++)f=g[k],c=f.split(":"),b=c[0],d=c[1],i=c[2],h=c[3],j=c[4],m.push(b!==""?(e=this.Composition.Players.getByCid(b),e?(e.set({loaded:d,totalsize:i,time:h,totaltime:j}),e.Video.set({totaltime:j})):void 0):void 0);return m}}),a=function(a){if(a.origin===window.location.protocol+"//"+window.location.host){App.recieveMessage(a.data);return a.data}},window.addEventListener("message",a,!1)}.call(this)