/*

Meemoo HTML Audio Visual Sequencer
  by Forrest Oliphant
    at Sembiki Interactive http://sembiki.com/
    and Media Lab Helsinki http://mlab.taik.fi/
(copyleft) 2011

Built with backbone.js, jQuery, and jQueryUI in CoffeeScript
  http://documentcloud.github.com/backbone/
  http://jquery.com/
  http://jqueryui.com/
  http://jashkenas.github.com/coffee-script/


This file is part of Meemoo.
  
  Meemoo is free software: you can redistribute it and/or modify 
  it under the terms of the GNU Affero General Public License as 
  published by the Free Software Foundation, either version 3 of 
  the License, or (at your option) any later version.
  
  Meemoo is distributed in the hope that it will be useful, but 
  WITHOUT ANY WARRANTY; without even the implied warranty of 
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the 
  GNU Affero General Public License for more details.
  
  You should have received a copy of the GNU Affero General 
  Public License along with Meemoo.  If not, see 
  <http://www.gnu.org/licenses/>.
  
*///     Underscore.js 1.1.7
//     (c) 2011 Jeremy Ashkenas, DocumentCloud Inc.
//     Underscore is freely distributable under the MIT license.
//     Portions of Underscore are inspired or borrowed from Prototype,
//     Oliver Steele's Functional, and John Resig's Micro-Templating.
//     For all details and documentation:
//     http://documentcloud.github.com/underscore
function guid(){return S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4()}function S4(){return((1+Math.random())*65536|0).toString(16).substring(1)}(function(){var a=this,b=a._,c={},d=Array.prototype,e=Object.prototype,f=Function.prototype,g=d.slice,h=d.unshift,i=e.toString,j=e.hasOwnProperty,k=d.forEach,l=d.map,m=d.reduce,n=d.reduceRight,o=d.filter,p=d.every,q=d.some,r=d.indexOf,s=d.lastIndexOf,t=Array.isArray,u=Object.keys,v=f.bind,w=function(a){return new B(a)};typeof module!="undefined"&&module.exports?(module.exports=w,w._=w):a._=w,w.VERSION="1.1.7";var x=w.each=w.forEach=function(a,b,d){if(a!=null)if(k&&a.forEach===k)a.forEach(b,d);else if(a.length===+a.length){for(var e=0,f=a.length;e<f;e++)if(e in a&&b.call(d,a[e],e,a)===c)return}else for(var g in a)if(j.call(a,g)&&b.call(d,a[g],g,a)===c)return};w.map=function(a,b,c){var d=[];if(a==null)return d;if(l&&a.map===l)return a.map(b,c);x(a,function(a,e,f){d[d.length]=b.call(c,a,e,f)});return d},w.reduce=w.foldl=w.inject=function(a,b,c,d){var e=c!==void 0;a==null&&(a=[]);if(m&&a.reduce===m){d&&(b=w.bind(b,d));return e?a.reduce(b,c):a.reduce(b)}x(a,function(a,f,g){e?c=b.call(d,c,a,f,g):(c=a,e=!0)});if(!e)throw new TypeError("Reduce of empty array with no initial value");return c},w.reduceRight=w.foldr=function(a,b,c,d){a==null&&(a=[]);if(n&&a.reduceRight===n){d&&(b=w.bind(b,d));return c!==void 0?a.reduceRight(b,c):a.reduceRight(b)}var e=(w.isArray(a)?a.slice():w.toArray(a)).reverse();return w.reduce(e,b,c,d)},w.find=w.detect=function(a,b,c){var d;y(a,function(a,e,f){if(b.call(c,a,e,f)){d=a;return!0}});return d},w.filter=w.select=function(a,b,c){var d=[];if(a==null)return d;if(o&&a.filter===o)return a.filter(b,c);x(a,function(a,e,f){b.call(c,a,e,f)&&(d[d.length]=a)});return d},w.reject=function(a,b,c){var d=[];if(a==null)return d;x(a,function(a,e,f){b.call(c,a,e,f)||(d[d.length]=a)});return d},w.every=w.all=function(a,b,d){var e=!0;if(a==null)return e;if(p&&a.every===p)return a.every(b,d);x(a,function(a,f,g){if(!(e=e&&b.call(d,a,f,g)))return c});return e};var y=w.some=w.any=function(a,b,d){b=b||w.identity;var e=!1;if(a==null)return e;if(q&&a.some===q)return a.some(b,d);x(a,function(a,f,g){if(e|=b.call(d,a,f,g))return c});return!!e};w.include=w.contains=function(a,b){var c=!1;if(a==null)return c;if(r&&a.indexOf===r)return a.indexOf(b)!=-1;y(a,function(a){if(c=a===b)return!0});return c},w.invoke=function(a,b){var c=g.call(arguments,2);return w.map(a,function(a){return(b.call?b||a:a[b]).apply(a,c)})},w.pluck=function(a,b){return w.map(a,function(a){return a[b]})},w.max=function(a,b,c){if(!b&&w.isArray(a))return Math.max.apply(Math,a);var d={computed:-Infinity};x(a,function(a,e,f){var g=b?b.call(c,a,e,f):a;g>=d.computed&&(d={value:a,computed:g})});return d.value},w.min=function(a,b,c){if(!b&&w.isArray(a))return Math.min.apply(Math,a);var d={computed:Infinity};x(a,function(a,e,f){var g=b?b.call(c,a,e,f):a;g<d.computed&&(d={value:a,computed:g})});return d.value},w.sortBy=function(a,b,c){return w.pluck(w.map(a,function(a,d,e){return{value:a,criteria:b.call(c,a,d,e)}}).sort(function(a,b){var c=a.criteria,d=b.criteria;return c<d?-1:c>d?1:0}),"value")},w.groupBy=function(a,b){var c={};x(a,function(a,d){var e=b(a,d);(c[e]||(c[e]=[])).push(a)});return c},w.sortedIndex=function(a,b,c){c||(c=w.identity);var d=0,e=a.length;while(d<e){var f=d+e>>1;c(a[f])<c(b)?d=f+1:e=f}return d},w.toArray=function(a){if(!a)return[];if(a.toArray)return a.toArray();if(w.isArray(a))return g.call(a);if(w.isArguments(a))return g.call(a);return w.values(a)},w.size=function(a){return w.toArray(a).length},w.first=w.head=function(a,b,c){return b!=null&&!c?g.call(a,0,b):a[0]},w.rest=w.tail=function(a,b,c){return g.call(a,b==null||c?1:b)},w.last=function(a){return a[a.length-1]},w.compact=function(a){return w.filter(a,function(a){return!!a})},w.flatten=function(a){return w.reduce(a,function(a,b){if(w.isArray(b))return a.concat(w.flatten(b));a[a.length]=b;return a},[])},w.without=function(a){return w.difference(a,g.call(arguments,1))},w.uniq=w.unique=function(a,b){return w.reduce(a,function(a,c,d){if(0==d||(b===!0?w.last(a)!=c:!w.include(a,c)))a[a.length]=c;return a},[])},w.union=function(){return w.uniq(w.flatten(arguments))},w.intersection=w.intersect=function(a){var b=g.call(arguments,1);return w.filter(w.uniq(a),function(a){return w.every(b,function(b){return w.indexOf(b,a)>=0})})},w.difference=function(a,b){return w.filter(a,function(a){return!w.include(b,a)})},w.zip=function(){var a=g.call(arguments),b=w.max(w.pluck(a,"length")),c=Array(b);for(var d=0;d<b;d++)c[d]=w.pluck(a,""+d);return c},w.indexOf=function(a,b,c){if(a==null)return-1;var d,e;if(c){d=w.sortedIndex(a,b);return a[d]===b?d:-1}if(r&&a.indexOf===r)return a.indexOf(b);for(d=0,e=a.length;d<e;d++)if(a[d]===b)return d;return-1},w.lastIndexOf=function(a,b){if(a==null)return-1;if(s&&a.lastIndexOf===s)return a.lastIndexOf(b);var c=a.length;while(c--)if(a[c]===b)return c;return-1},w.range=function(a,b,c){arguments.length<=1&&(b=a||0,a=0),c=arguments[2]||1;var d=Math.max(Math.ceil((b-a)/c),0),e=0,f=Array(d);while(e<d)f[e++]=a,a+=c;return f},w.bind=function(a,b){if(a.bind===v&&v)return v.apply(a,g.call(arguments,1));var c=g.call(arguments,2);return function(){return a.apply(b,c.concat(g.call(arguments)))}},w.bindAll=function(a){var b=g.call(arguments,1);b.length==0&&(b=w.functions(a)),x(b,function(b){a[b]=w.bind(a[b],a)});return a},w.memoize=function(a,b){var c={};b||(b=w.identity);return function(){var d=b.apply(this,arguments);return j.call(c,d)?c[d]:c[d]=a.apply(this,arguments)}},w.delay=function(a,b){var c=g.call(arguments,2);return setTimeout(function(){return a.apply(a,c)},b)},w.defer=function(a){return w.delay.apply(w,[a,1].concat(g.call(arguments,1)))};var z=function(a,b,c){var d;return function(){var e=this,f=arguments,g=function(){d=null,a.apply(e,f)};c&&clearTimeout(d);if(c||!d)d=setTimeout(g,b)}};w.throttle=function(a,b){return z(a,b,!1)},w.debounce=function(a,b){return z(a,b,!0)},w.once=function(a){var b=!1,c;return function(){if(b)return c;b=!0;return c=a.apply(this,arguments)}},w.wrap=function(a,b){return function(){var c=[a].concat(g.call(arguments));return b.apply(this,c)}},w.compose=function(){var a=g.call(arguments);return function(){var b=g.call(arguments);for(var c=a.length-1;c>=0;c--)b=[a[c].apply(this,b)];return b[0]}},w.after=function(a,b){return function(){if(--a<1)return b.apply(this,arguments)}},w.keys=u||function(a){if(a!==Object(a))throw new TypeError("Invalid object");var b=[];for(var c in a)j.call(a,c)&&(b[b.length]=c);return b},w.values=function(a){return w.map(a,w.identity)},w.functions=w.methods=function(a){var b=[];for(var c in a)w.isFunction(a[c])&&b.push(c);return b.sort()},w.extend=function(a){x(g.call(arguments,1),function(b){for(var c in b)b[c]!==void 0&&(a[c]=b[c])});return a},w.defaults=function(a){x(g.call(arguments,1),function(b){for(var c in b)a[c]==null&&(a[c]=b[c])});return a},w.clone=function(a){return w.isArray(a)?a.slice():w.extend({},a)},w.tap=function(a,b){b(a);return a},w.isEqual=function(a,b){if(a===b)return!0;var c=typeof a,d=typeof b;if(c!=d)return!1;if(a==b)return!0;if(!a&&b||a&&!b)return!1;a._chain&&(a=a._wrapped),b._chain&&(b=b._wrapped);if(a.isEqual)return a.isEqual(b);if(b.isEqual)return b.isEqual(a);if(w.isDate(a)&&w.isDate(b))return a.getTime()===b.getTime();if(w.isNaN(a)&&w.isNaN(b))return!1;if(w.isRegExp(a)&&w.isRegExp(b))return a.source===b.source&&a.global===b.global&&a.ignoreCase===b.ignoreCase&&a.multiline===b.multiline;if(c!=="object")return!1;if(a.length&&a.length!==b.length)return!1;var e=w.keys(a),f=w.keys(b);if(e.length!=f.length)return!1;for(var g in a)if(!(g in b)||!w.isEqual(a[g],b[g]))return!1;return!0},w.isEmpty=function(a){if(w.isArray(a)||w.isString(a))return a.length===0;for(var b in a)if(j.call(a,b))return!1;return!0},w.isElement=function(a){return!!a&&a.nodeType==1},w.isArray=t||function(a){return i.call(a)==="[object Array]"},w.isObject=function(a){return a===Object(a)},w.isArguments=function(a){return!!a&&!!j.call(a,"callee")},w.isFunction=function(a){return!!(a&&a.constructor&&a.call&&a.apply)},w.isString=function(a){return!!(a===""||a&&a.charCodeAt&&a.substr)},w.isNumber=function(a){return!!(a===0||a&&a.toExponential&&a.toFixed)},w.isNaN=function(a){return a!==a},w.isBoolean=function(a){return a===!0||a===!1},w.isDate=function(a){return!!(a&&a.getTimezoneOffset&&a.setUTCFullYear)},w.isRegExp=function(a){return!(!(a&&a.test&&a.exec)||!a.ignoreCase&&a.ignoreCase!==!1)},w.isNull=function(a){return a===null},w.isUndefined=function(a){return a===void 0},w.noConflict=function(){a._=b;return this},w.identity=function(a){return a},w.times=function(a,b,c){for(var d=0;d<a;d++)b.call(c,d)},w.mixin=function(a){x(w.functions(a),function(b){D(b,w[b]=a[b])})};var A=0;w.uniqueId=function(a){var b=A++;return a?a+b:b},w.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g},w.template=function(a,b){var c=w.templateSettings,d="var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+a.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(c.interpolate,function(a,b){return"',"+b.replace(/\\'/g,"'")+",'"}).replace(c.evaluate||null,function(a,b){return"');"+b.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+"__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');",e=new Function("obj",d);return b?e(b):e};var B=function(a){this._wrapped=a};w.prototype=B.prototype;var C=function(a,b){return b?w(a).chain():a},D=function(a,b){B.prototype[a]=function(){var a=g.call(arguments);h.call(a,this._wrapped);return C(b.apply(w,a),this._chain)}};w.mixin(w),x(["pop","push","reverse","shift","sort","splice","unshift"],function(a){var b=d[a];B.prototype[a]=function(){b.apply(this._wrapped,arguments);return C(this._wrapped,this._chain)}}),x(["concat","join","slice"],function(a){var b=d[a];B.prototype[a]=function(){return C(b.apply(this._wrapped,arguments),this._chain)}}),B.prototype.chain=function(){this._chain=!0;return this},B.prototype.value=function(){return this._wrapped}})(),function(){var a=this,b=a.Backbone,c;typeof exports!="undefined"?c=exports:c=a.Backbone={},c.VERSION="0.5.3";var d=a._;!d&&typeof require!="undefined"&&(d=require("underscore")._);var e=a.jQuery||a.Zepto;c.noConflict=function(){a.Backbone=b;return this},c.emulateHTTP=!1,c.emulateJSON=!1,c.Events={bind:function(a,b,c){var d=this._callbacks||(this._callbacks={}),e=d[a]||(d[a]=[]);e.push([b,c]);return this},unbind:function(a,b){var c;if(!a)this._callbacks={};else if(c=this._callbacks)if(!b)c[a]=[];else{var d=c[a];if(!d)return this;for(var e=0,f=d.length;e<f;e++)if(d[e]&&b===d[e][0]){d[e]=null;break}}return this},trigger:function(a){var b,c,d,e,f,g=2;if(!(c=this._callbacks))return this;while(g--){d=g?a:"all";if(b=c[d])for(var h=0,i=b.length;h<i;h++)(e=b[h])?(f=g?Array.prototype.slice.call(arguments,1):arguments,e[0].apply(e[1]||this,f)):(b.splice(h,1),h--,i--)}return this}},c.Model=function(a,b){var c;a||(a={});if(c=this.defaults)d.isFunction(c)&&(c=c.call(this)),a=d.extend({},c,a);this.attributes={},this._escapedAttributes={},this.cid=d.uniqueId("c"),this.set(a,{silent:!0}),this._changed=!1,this._previousAttributes=d.clone(this.attributes),b&&b.collection&&(this.collection=b.collection),this.initialize(a,b)},d.extend(c.Model.prototype,c.Events,{_previousAttributes:null,_changed:!1,idAttribute:"id",initialize:function(){},toJSON:function(){return d.clone(this.attributes)},get:function(a){return this.attributes[a]},escape:function(a){var b;if(b=this._escapedAttributes[a])return b;var c=this.attributes[a];return this._escapedAttributes[a]=w(c==null?"":""+c)},has:function(a){return this.attributes[a]!=null},set:function(a,b){b||(b={});if(!a)return this;a.attributes&&(a=a.attributes);var c=this.attributes,e=this._escapedAttributes;if(!b.silent&&this.validate&&!this._performValidation(a,b))return!1;this.idAttribute in a&&(this.id=a[this.idAttribute]);var f=this._changing;this._changing=!0;for(var g in a){var h=a[g];d.isEqual(c[g],h)||(c[g]=h,delete e[g],this._changed=!0,b.silent||this.trigger("change:"+g,this,h,b))}!f&&!b.silent&&this._changed&&this.change(b),this._changing=!1;return this},unset:function(a,b){if(!(a in this.attributes))return this;b||(b={});var c=this.attributes[a],d={};d[a]=void 0;if(!b.silent&&this.validate&&!this._performValidation(d,b))return!1;delete this.attributes[a],delete this._escapedAttributes[a],a==this.idAttribute&&delete this.id,this._changed=!0,b.silent||(this.trigger("change:"+a,this,void 0,b),this.change(b));return this},clear:function(a){a||(a={});var b,c=this.attributes,d={};for(b in c)d[b]=void 0;if(!a.silent&&this.validate&&!this._performValidation(d,a))return!1;this.attributes={},this._escapedAttributes={},this._changed=!0;if(!a.silent){for(b in c)this.trigger("change:"+b,this,void 0,a);this.change(a)}return this},fetch:function(a){a||(a={});var b=this,d=a.success;a.success=function(c,e,f){if(!b.set(b.parse(c,f),a))return!1;d&&d(b,c)},a.error=v(a.error,b,a);return(this.sync||c.sync).call(this,"read",this,a)},save:function(a,b){b||(b={});if(a&&!this.set(a,b))return!1;var d=this,e=b.success;b.success=function(a,c,f){if(!d.set(d.parse(a,f),b))return!1;e&&e(d,a,f)},b.error=v(b.error,d,b);var f=this.isNew()?"create":"update";return(this.sync||c.sync).call(this,f,this,b)},destroy:function(a){a||(a={});if(this.isNew())return this.trigger("destroy",this,this.collection,a);var b=this,d=a.success;a.success=function(c){b.trigger("destroy",b,b.collection,a),d&&d(b,c)},a.error=v(a.error,b,a);return(this.sync||c.sync).call(this,"delete",this,a)},url:function(){var a=t(this.collection)||this.urlRoot||u();if(this.isNew())return a;return a+(a.charAt(a.length-1)=="/"?"":"/")+encodeURIComponent(this.id)},parse:function(a,b){return a},clone:function(){return new this.constructor(this)},isNew:function(){return this.id==null},change:function(a){this.trigger("change",this,a),this._previousAttributes=d.clone(this.attributes),this._changed=!1},hasChanged:function(a){if(a)return this._previousAttributes[a]!=this.attributes[a];return this._changed},changedAttributes:function(a){a||(a=this.attributes);var b=this._previousAttributes,c=!1;for(var e in a)d.isEqual(b[e],a[e])||(c=c||{},c[e]=a[e]);return c},previous:function(a){if(!a||!this._previousAttributes)return null;return this._previousAttributes[a]},previousAttributes:function(){return d.clone(this._previousAttributes)},_performValidation:function(a,b){var c=this.validate(a);if(c){b.error?b.error(this,c,b):this.trigger("error",this,c,b);return!1}return!0}}),c.Collection=function(a,b){b||(b={}),b.comparator&&(this.comparator=b.comparator),d.bindAll(this,"_onModelEvent","_removeReference"),this._reset(),a&&this.reset(a,{silent:!0}),this.initialize.apply(this,arguments)},d.extend(c.Collection.prototype,c.Events,{model:c.Model,initialize:function(){},toJSON:function(){return this.map(function(a){return a.toJSON()})},add:function(a,b){if(d.isArray(a))for(var c=0,e=a.length;c<e;c++)this._add(a[c],b);else this._add(a,b);return this},remove:function(a,b){if(d.isArray(a))for(var c=0,e=a.length;c<e;c++)this._remove(a[c],b);else this._remove(a,b);return this},get:function(a){if(a==null)return null;return this._byId[a.id!=null?a.id:a]},getByCid:function(a){return a&&this._byCid[a.cid||a]},at:function(a){return this.models[a]},sort:function(a){a||(a={});if(!this.comparator)throw new Error("Cannot sort a set without a comparator");this.models=this.sortBy(this.comparator),a.silent||this.trigger("reset",this,a);return this},pluck:function(a){return d.map(this.models,function(b){return b.get(a)})},reset:function(a,b){a||(a=[]),b||(b={}),this.each(this._removeReference),this._reset(),this.add(a,{silent:!0}),b.silent||this.trigger("reset",this,b);return this},fetch:function(a){a||(a={});var b=this,d=a.success;a.success=function(c,e,f){b[a.add?"add":"reset"](b.parse(c,f),a),d&&d(b,c)},a.error=v(a.error,b,a);return(this.sync||c.sync).call(this,"read",this,a)},create:function(a,b){var c=this;b||(b={}),a=this._prepareModel(a,b);if(!a)return!1;var d=b.success;b.success=function(a,e,f){c.add(a,b),d&&d(a,e,f)},a.save(null,b);return a},parse:function(a,b){return a},chain:function(){return d(this.models).chain()},_reset:function(a){this.length=0,this.models=[],this._byId={},this._byCid={}},_prepareModel:function(a,b){if(a instanceof c.Model)a.collection||(a.collection=this);else{var d=a;a=new this.model(d,{collection:this}),a.validate&&!a._performValidation(d,b)&&(a=!1)}return a},_add:function(a,b){b||(b={}),a=this._prepareModel(a,b);if(!a)return!1;var c=this.getByCid(a);if(c)throw new Error(["Can't add the same model to a set twice",c.id]);this._byId[a.id]=a,this._byCid[a.cid]=a;var d=b.at!=null?b.at:this.comparator?this.sortedIndex(a,this.comparator):this.length;this.models.splice(d,0,a),a.bind("all",this._onModelEvent),this.length++,b.silent||a.trigger("add",a,this,b);return a},_remove:function(a,b){b||(b={}),a=this.getByCid(a)||this.get(a);if(!a)return null;delete this._byId[a.id],delete this._byCid[a.cid],this.models.splice(this.indexOf(a),1),this.length--,b.silent||a.trigger("remove",a,this,b),this._removeReference(a);return a},_removeReference:function(a){this==a.collection&&delete a.collection,a.unbind("all",this._onModelEvent)},_onModelEvent:function(a,b,c,d){if(a!="add"&&a!="remove"||c==this)a=="destroy"&&this._remove(b,d),b&&a==="change:"+b.idAttribute&&(delete this._byId[b.previous(b.idAttribute)],this._byId[b.id]=b),this.trigger.apply(this,arguments)}});var f=["forEach","each","map","reduce","reduceRight","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","sortBy","sortedIndex","toArray","size","first","rest","last","without","indexOf","lastIndexOf","isEmpty","groupBy"];d.each(f,function(a){c.Collection.prototype[a]=function(){return d[a].apply(d,[this.models].concat(d.toArray(arguments)))}}),c.Router=function(a){a||(a={}),a.routes&&(this.routes=a.routes),this._bindRoutes(),this.initialize.apply(this,arguments)};var g=/:([\w\d]+)/g,h=/\*([\w\d]+)/g,i=/[-[\]{}()+?.,\\^$|#\s]/g;d.extend(c.Router.prototype,c.Events,{initialize:function(){},route:function(a,b,e){c.history||(c.history=new c.History),d.isRegExp(a)||(a=this._routeToRegExp(a)),c.history.route(a,d.bind(function(c){var d=this._extractParameters(a,c);e.apply(this,d),this.trigger.apply(this,["route:"+b].concat(d))},this))},navigate:function(a,b){c.history.navigate(a,b)},_bindRoutes:function(){if(!!this.routes){var a=[];for(var b in this.routes)a.unshift([b,this.routes[b]]);for(var c=0,d=a.length;c<d;c++)this.route(a[c][0],a[c][1],this[a[c][1]])}},_routeToRegExp:function(a){a=a.replace(i,"\\$&").replace(g,"([^/]*)").replace(h,"(.*?)");return new RegExp("^"+a+"$")},_extractParameters:function(a,b){return a.exec(b).slice(1)}}),c.History=function(){this.handlers=[],d.bindAll(this,"checkUrl")};var j=/^#*/,k=/msie [\w.]+/,l=!1;d.extend(c.History.prototype,{interval:50,getFragment:function(a,b){if(a==null)if(this._hasPushState||b){a=window.location.pathname;var c=window.location.search;c&&(a+=c),a.indexOf(this.options.root)==0&&(a=a.substr(this.options.root.length))}else a=window.location.hash;return decodeURIComponent(a.replace(j,""))},start:function(a){if(l)throw new Error("Backbone.history has already been started");this.options=d.extend({},{root:"/"},this.options,a),this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&window.history&&window.history.pushState);var b=this.getFragment(),c=document.documentMode,f=k.exec(navigator.userAgent.toLowerCase())&&(!c||c<=7);f&&(this.iframe=e('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(b)),this._hasPushState?e(window).bind("popstate",this.checkUrl):"onhashchange"in window&&!f?e(window).bind("hashchange",this.checkUrl):setInterval(this.checkUrl,this.interval),this.fragment=b,l=!0;var g=window.location,h=g.pathname==this.options.root;if(this._wantsPushState&&!this._hasPushState&&!h){this.fragment=this.getFragment(null,!0),window.location.replace(this.options.root+"#"+this.fragment);return!0}this._wantsPushState&&this._hasPushState&&h&&g.hash&&(this.fragment=g.hash.replace(j,""),window.history.replaceState({},document.title,g.protocol+"//"+g.host+this.options.root+this.fragment));if(!this.options.silent)return this.loadUrl()},route:function(a,b){this.handlers.unshift({route:a,callback:b})},checkUrl:function(a){var b=this.getFragment();b==this.fragment&&this.iframe&&(b=this.getFragment(this.iframe.location.hash));if(b==this.fragment||b==decodeURIComponent(this.fragment))return!1;this.iframe&&this.navigate(b),this.loadUrl()||this.loadUrl(window.location.hash)},loadUrl:function(a){var b=this.fragment=this.getFragment(a),c=d.any(this.handlers,function(a){if(a.route.test(b)){a.callback(b);return!0}});return c},navigate:function(a,b){var c=(a||"").replace(j,"");if(this.fragment!=c&&this.fragment!=decodeURIComponent(c)){if(this._hasPushState){var d=window.location;c.indexOf(this.options.root)!=0&&(c=this.options.root+c),this.fragment=c,window.history.pushState({},document.title,d.protocol+"//"+d.host+c)}else window.location.hash=this.fragment=c,this.iframe&&c!=this.getFragment(this.iframe.location.hash)&&(this.iframe.document.open().close(),this.iframe.location.hash=c);b&&this.loadUrl(a)}}}),c.View=function(a){this.cid=d.uniqueId("view"),this._configure(a||{}),this._ensureElement(),this.delegateEvents(),this.initialize.apply(this,arguments)};var m=function(a){return e(a,this.el)},n=/^(\S+)\s*(.*)$/,o=["model","collection","el","id","attributes","className","tagName"];d.extend(c.View.prototype,c.Events,{tagName:"div",$:m,initialize:function(){},render:function(){return this},remove:function(){e(this.el).remove();return this},make:function(a,b,c){var d=document.createElement(a);b&&e(d).attr(b),c&&e(d).html(c);return d},delegateEvents:function(a){if(!!a||!!(a=this.events)){d.isFunction(a)&&(a=a.call(this)),e(this.el).unbind(".delegateEvents"+this.cid);for(var b in a){var c=this[a[b]];if(!c)throw new Error('Event "'+a[b]+'" does not exist');var f=b.match(n),g=f[1],h=f[2];c=d.bind(c,this),g+=".delegateEvents"+this.cid,h===""?e(this.el).bind(g,c):e(this.el).delegate(h,g,c)}}},_configure:function(a){this.options&&(a=d.extend({},this.options,a));for(var b=0,c=o.length;b<c;b++){var e=o[b];a[e]&&(this[e]=a[e])}this.options=a},_ensureElement:function(){if(!this.el){var a=this.attributes||{};this.id&&(a.id=this.id),this.className&&(a["class"]=this.className),this.el=this.make(this.tagName,a)}else d.isString(this.el)&&(this.el=e(this.el).get(0))}});var p=function(a,b){var c=s(this,a,b);c.extend=this.extend;return c};c.Model.extend=c.Collection.extend=c.Router.extend=c.View.extend=p;var q={create:"POST",update:"PUT","delete":"DELETE",read:"GET"};c.sync=function(a,b,f){var g=q[a],h=d.extend({type:g,dataType:"json"},f);h.url||(h.url=t(b)||u()),!h.data&&b&&(a=="create"||a=="update")&&(h.contentType="application/json",h.data=JSON.stringify(b.toJSON())),c.emulateJSON&&(h.contentType="application/x-www-form-urlencoded",h.data=h.data?{model:h.data}:{}),c.emulateHTTP&&(g==="PUT"||g==="DELETE")&&(c.emulateJSON&&(h.data._method=g),h.type="POST",h.beforeSend=function(a){a.setRequestHeader("X-HTTP-Method-Override",g)}),h.type!=="GET"&&!c.emulateJSON&&(h.processData=!1);return e.ajax(h)};var r=function(){},s=function(a,b,c){var e;b&&b.hasOwnProperty("constructor")?e=b.constructor:e=function(){return a.apply(this,arguments)},d.extend(e,a),r.prototype=a.prototype,e.prototype=new r,b&&d.extend(e.prototype,b),c&&d.extend(e,c),e.prototype.constructor=e,e.__super__=a.prototype;return e},t=function(a){if(!a||!a.url)return null;return d.isFunction(a.url)?a.url():a.url},u=function(){throw new Error('A "url" property or function must be specified')},v=function(a,b,c){return function(d){a?a(b,d,c):b.trigger("error",b,d,c)}},w=function(a){return a.replace(/&(?!\w+;|#\d+;|#x[\da-f]+;)/gi,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")}}.call(this);var Store=function(a){this.name=a;var b=localStorage.getItem(this.name);this.data=b&&JSON.parse(b)||{}};_.extend(Store.prototype,{save:function(){localStorage.setItem(this.name,JSON.stringify(this.data))},create:function(a){a.id||(a.id=a.attributes.id=guid()),this.data[a.id]=a,this.save();return a},update:function(a){this.data[a.id]=a,this.save();return a},find:function(a){return this.data[a.id]},findAll:function(){return _.values(this.data)},destroy:function(a){delete this.data[a.id],this.save();return a}}),Backbone.sync=function(a,b,c){var d,e=b.localStorage||b.collection.localStorage;switch(a){case"read":d=b.id?e.find(b):e.findAll();break;case"create":d=e.create(b);break;case"update":d=e.update(b);break;case"delete":d=e.destroy(b)}d?c.success(d):c.error("Record not found")},function(){this.Composition=Backbone.Model.extend({defaults:{title:"untitled composition",description:"mixed with sembiki meemoo audio visual sequencer",mixer:"me!"},initialize:function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L;this.get("loadJSON")!==void 0&&(i=this.get("loadJSON"),i!==""&&(a=JSON.parse(i),a.id&&(this.attributes.parent_id=a.id,a.parent_id&&(this.attributes.parent_id+=","+a.parent_id)),a.bpm&&(this.attributes.bpm=a.bpm),a.description&&(this.attributes.description="Forked from "+a.title+" by "+a.mixer+" --- "+a.description),a.mixer&&(this.attributes.mixer=a.mixer),a.patterns&&(this.attributes.patterns=a.patterns),a.title&&(this.attributes.title="Re: "+a.title),a.sequences&&(this.attributes.sequences=a.sequences),a.videos&&(this.attributes.videos=a.videos))),this.Videos=new VideoList;if(this.attributes.videos){E=this.attributes.videos;for(o=0,s=E.length;o<s;o++){n=E[o],g=new Video({Composition:this,title:n.title,duration:n.duration,webm:n.webm,mp4:n.mp4,ytid:n.ytid,triggers:n.triggers}),n.newcid=g.cid,this.Videos.add(g);if(n.players){F=n.players;for(p=0,t=F.length;p<t;p++)k=F[p],c=new Player({Composition:this,Video:g}),c.oldcid=k.id,k.newcid=c.cid,g.Players.add(c)}}}this.Patterns=new PatternList;if(this.attributes.patterns){G=this.attributes.patterns;for(q=0,u=G.length;q<u;q++){j=G[q],b=new Pattern({Composition:this,trigger_id:j.trigger_id,next:j.next,chance:j.chance,beats:j.beats}),this.Patterns.add(b),j.newcid=b.cid;if(j.tracks){H=j.tracks;for(r=0,v=H.length;r<v;r++){m=H[r],h=m.player_id,I=this.Videos.models;for(A=0,w=I.length;A<w;A++){n=I[A],J=n.Players.models;for(B=0,x=J.length;B<x;B++){k=J[B];if(h===k.oldcid){f=b.addTrack(k),f.setLine(m.line);break}}}}}}}this.Pattern=null,this.nextPattern=null,this.playing=!1,this.queuedMessages="",this.Sequences=new SequenceList;if(this.attributes.sequences){K=this.attributes.sequences;for(C=0,y=K.length;C<y;C++){l=K[C],d=new Sequence({Composition:this,length:l.length}),this.Sequences.add(d);if(l.tracks){L=l.tracks;for(D=0,z=L.length;D<z;D++)m=L[D],m.line.length>0&&(e=d.addTrack(),e.setLine(m.line))}}}this.Sequence=null,this.nextSequence=null,this.attributes.bpm?this.setBpm(this.attributes.bpm):this.setBpm(120);return this.ListView=new CompositionListView({model:this})},setBpm:function(a){if(0<a&&a<=500){this.set({bpm:a}),this.bpm=a,this.bpm_ms=Math.round(6e4/this.bpm);return this.play()}},play:function(){clearTimeout(App.timer);return App.timer=setTimeout("App.Composition.step()",this.bpm_ms)},stop:function(){this.Pattern=null;return this.playing=!1},step:function(){this.Pattern&&this.Pattern.step(),this.sendQueuedMessages();return this.play()},cuePattern:function(a){this.nextPattern=a;if(this.playing===!1){this.Pattern=a,this.nextPattern=null;return this.playing=!0}},cueSequence:function(a){this.nextSequence=a;if(this.playing===!1){this.Sequence=a,this.nextSequence=null,this.loop();return this.playing=!0}},playSequence:function(a){this.Sequence=a,this.nextPattern=null;return this.loop()},stopSequence:function(a){if(this.Sequence===a)return this.Sequence=null},loop:function(){var a,b,c,d,e,f,g,h,i,j,k,l;if(this.nextPattern!==null)this.Pattern=this.nextPattern,this.nextPattern=null,this.Sequence=null;else{this.nextSequence!==null&&(this.Sequence=this.nextSequence,this.nextSequence=null),c=null,this.Sequence!==null&&(c=this.Sequence.step()),c===null&&this.Pattern!==null&&(c=this.Pattern.get("next")),f=0,b=[],k=this.Patterns.models;for(g=0,i=k.length;g<i;g++)d=k[g],d.get("trigger_id")===c&&(f+=d.get("chance"),b.push(d));if(b.length===1)return this.Pattern=b[0];if(b.length>1){e=Math.random()*f,l=[];for(h=0,j=b.length;h<j;h++){a=b[h];if(e<a.get("chance")){this.Pattern=a;return}l.push(e-=a.get("chance"))}return l}}},multitrigger:function(a){var b,c,d,e,f;c="";for(e=0,f=a.length;e<f;e++)b=a[e],d=b.player.Video.get("triggers")[b.trigger],d!==null&&d!==void 0&&(c+="/seek/",c+=""+b.player.cid+"/",c+=""+d+"|");if(c!=="")return App.postRawMessageToViewer(c)},queueMessage:function(a){return this.queuedMessages+=a+"|"},sendQueuedMessages:function(){this.queuedMessages===""&&(this.queuedMessages="/"),App.postRawMessageToViewer(this.queuedMessages);return this.queuedMessages=""},initializeView:function(){var a,b,c,d,e,f,g,h,i,j,k,l;this.View=new CompositionView({model:this}),j=this.Videos.models;for(d=0,g=j.length;d<g;d++)c=j[d],c.initializeView();k=this.Patterns.models;for(e=0,h=k.length;e<h;e++)a=k[e],a.initializeView();l=this.Sequences.models;for(f=0,i=l.length;f<i;f++)b=l[f],b.initializeView();this.saveLastSaved();return setTimeout("App.reloadVideos()",2e3)},addVideo:function(a){var b;a==null&&(a=""),b=new Video({Composition:this,firstValue:a}),this.Videos.add(b);return b},addPattern:function(){var a,b;b=this.Patterns.models.length,a=new Pattern({Composition:this,trigger_id:b,next:b}),this.Patterns.add(a),a.addTracks();return a},addSequence:function(){var a;a=new Sequence({Composition:this}),this.Sequences.add(a),a.addTrack();return a},toJSON:function(){var a;return a={id:this.id,title:this.get("title"),description:this.get("description"),mixer:this.get("mixer"),bpm:this.get("bpm"),videos:this.Videos,patterns:this.Patterns,sequences:this.Sequences,parent_id:this.get("parent_id")}},"delete":function(){this.destroy(),this.ListView.remove();try{return this.View.remove()}catch(a){}},saveLastSaved:function(){return this.lastsaved=JSON.stringify(this)},changesMade:function(){var a;a=this.lastsaved!==JSON.stringify(this),this.View&&a&&this.View.$(".composition-save-button").button({label:"Save!!!"});return a},getPlayerByCid:function(a){var b,c,d,e,f,g,h,i;h=this.Videos.models;for(d=0,f=h.length;d<f;d++){c=h[d],i=c.Players.models;for(e=0,g=i.length;e<g;e++){b=i[e];if(b.cid===a)return b}}return null}}),this.CompositionList=Backbone.Collection.extend({model:Composition,localStorage:new Store("compositions")}),this.CompositionListView=Backbone.View.extend({tagName:"div",className:"composition-list",template:_.template($("#composition-list-template").html()),events:{"click .comp_load_button":"load","click .comp_export_button":"export","click .comp_delete_button":"delete"},render:function(){$(this.el).html(this.template(this.model.toJSON())),this.$(".comp_load_button").button({icons:{primary:"ui-icon-folder-open"}}),this.$(".comp_export_button").button({icons:{primary:"ui-icon-clipboard"}}),this.$(".comp_delete_button").button({icons:{primary:"ui-icon-trash"
}});return this},initialize:function(){this.render();return $("#comp_dialog").append($(this.el))},load:function(){if(App.Composition.changesMade()&&!confirm("You have unsaved changes in the current composition. Discard unsaved changes?"))$("#comp_dialog").dialog("close");else{App.loadComposition(this.model);return $("#comp_dialog").dialog("close")}},"export":function(){$("#comp_export_dialog textarea").text(JSON.stringify(this.model));return $("#comp_export_dialog").dialog({width:400,height:300,position:"right top"})},"delete":function(){if(confirm("Are you sure you want to remove this composition ("+this.model.get("title")+")?"))return this.model["delete"]()},remove:function(){return $(this.el).remove()}})}.call(this),function(){this.CompositionView=Backbone.View.extend({tagName:"div",className:"composition",template:_.template($("#composition-template").html()),events:{"click .composition-save-button":"save","click .composition-export-button":"export","mouseover .navigable":"mouseoverNavigable","keydown .automulti":"automulti","keydown .automulti2":"automulti2","click .add-video":"addVideo","click .add-pattern":"addPattern","click .add-sequence":"addSequence","click .play-all-button":"playAll","click .pause-all-button":"pauseAll","blur .editable":"setInfo","blur .comp_info_bpm":"setBpm"},render:function(){$(this.el).html(this.template(this.model.toJSON())),this.$(".composition-save-button").button({icons:{primary:"ui-icon-disk"}}),this.$(".composition-export-button").button({icons:{primary:"ui-icon-clipboard"}}),this.$(".automulti").button({icons:{primary:"ui-icon-battery-1"}}),this.$(".automulti2").button({icons:{primary:"ui-icon-battery-3"}}),this.$(".add-video").button({icons:{primary:"ui-icon-plus"}}),this.$(".add-pattern").button({icons:{primary:"ui-icon-plus"}}),this.$(".add-sequence").button({icons:{primary:"ui-icon-plus"}}),this.$(".play-all-button").button({icons:{primary:"ui-icon-play"}});return this.$(".pause-all-button").button({icons:{primary:"ui-icon-pause"}})},initialize:function(){this.render();return $("#setup").append($(this.el))},mouseoverNavigable:function(a){return $(a.currentTarget).focus()},addVideo:function(){var a;a=this.model.addVideo(this.$(".add-video-input").val()),this.$(".add-video-input").val(""),a.initializeView(),a.View.$(".video-sources").show();return a.View.testFirst()},addPattern:function(){var a;a=this.model.addPattern();return a.initializeView()},addSequence:function(){var a;a=this.model.addSequence();return a.initializeView()},automulti:function(a){var b,c,d,e,f,g,h,i;d=App.keycodes.indexOf(a.keyCode);if(d!==-1){b=0,h=this.model.Videos.models,i=[];for(f=0,g=h.length;f<g;f++)e=h[f],i.push(function(){var a,f,g,h;g=e.Players.models,h=[];for(a=0,f=g.length;a<f;a++){c=g[a];if(b===Math.floor(d/10)){c.View.trigger(d%10);break}b++}return h}());return i}},automulti2:function(a){var b,c,d,e,f,g,h,i,j,k,l;d=App.keycodes.indexOf(a.keyCode);if(d!==-1){e="",k=this.model.Videos.models;for(g=0,i=k.length;g<i;g++){f=k[g],c=parseFloat(f.get("triggers")[d]);if(c===c){l=f.Players.models;for(h=0,j=l.length;h<j;h++)b=l[h],e+="/seek/"+b.cid+"/"+c+"|"}}return App.postRawMessageToViewer(e)}},playAll:function(){var a,b,c,d,e,f;e=this.model.Videos.models,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(function(){var c,d,e,f;e=b.Players.models,f=[];for(c=0,d=e.length;c<d;c++)a=e[c],f.push(a.View.play());return f}());return f},pauseAll:function(){var a,b,c,d,e,f;e=this.model.Videos.models,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(function(){var c,d,e,f;e=b.Players.models,f=[];for(c=0,d=e.length;c<d;c++)a=e[c],f.push(a.View.pause());return f}());return f},save:function(){this.model.save(),this.model.saveLastSaved(),this.model.ListView.render(),this.$(".composition-save-button").button({label:"Save"});return _gaq.push(["_trackEvent","Composition","Save "+this.model.id,JSON.stringify(this.model)])},setInfo:function(){return this.model.set({title:this.$(".comp_info_title").text().trim(),mixer:this.$(".comp_info_mixer").text().trim(),description:this.$(".comp_info_description").text().trim()})},setBpm:function(){return this.model.setBpm(parseInt(this.$(".comp_info_bpm").val()))},"export":function(){return this.model.ListView["export"]()},"delete":function(){if(confirm("Are you sure you want to remove this composition ("+this.model.get("title")+")?"))return this.model["delete"]()},remove:function(){this.model.stop(),App.postMessageToViewer("remove","ALL");return $(this.el).empty().remove()}})}.call(this),function(){this.Video=Backbone.Model.extend({defaults:{title:"",triggers:[]},initialize:function(){var a;this.Players=new PlayerList,a=this.get("firstValue"),a&&a!==""&&(a.indexOf(".webm")!==-1?this.set({webm:a}):a.indexOf(".mp4")!==-1||a.indexOf(".m4v")!==-1||a.indexOf(".mov")!==-1?this.set({mp4:a}):a.indexOf("youtube.com")!==-1?(a=a.split("v=")[1].split("&")[0],this.set({ytid:a})):this.set({ytid:a}));if(this.get("title")==="")return this.set({title:this.get("ytid")})},initializeView:function(){var a,b,c,d;this.View=new VideoView({model:this}),d=this.Players.models;for(b=0,c=d.length;b<c;b++)a=d[b],a.initializeView();return this.updateTriggers()},addTrigger:function(a,b){if(a<App.triggers.length){b=parseFloat(b);if(this.get("triggers").indexOf(b)===-1){this.get("triggers")[a]=b;return this.updateTriggers()}}},updateTriggers:function(){if(this.View)return this.View.updateTriggers()},toJSON:function(){var a;return a={id:this.cid,title:this.get("title"),duration:parseFloat(this.get("duration")),webm:this.get("webm"),mp4:this.get("mp4"),ytid:this.get("ytid"),triggers:this.get("triggers"),players:this.Players}},addPlayer:function(){return this.Players.add(new Player({Composition:this.get("Composition"),Video:this}))},remove:function(){var a,b,c,d;d=this.Players.models;for(b=0,c=d.length;b<c;b++)a=d[b],a.View?a.View.remove():a.remove();return this.get("Composition").Videos.remove(this)}}),this.VideoList=Backbone.Collection.extend({model:Video,getOrAddVideo:function(a,b){var c,d,e,f,g;g=this.models;for(e=0,f=g.length;e<f;e++){d=g[e];if(b===d.get("ytid"))return d}c=new Video({Composition:a,ytid:b}),this.add(c);return c}})}.call(this),function(){this.VideoView=Backbone.View.extend({tagName:"div",className:"video",template:_.template($("#video-template").html()),events:{"blur .video-title":"saveTitle","click .video-edit-triggers":"editTriggers","click .video-edit-sources":"editSources","click .video-addplayer":"addPlayer","click .video-delete":"delete","blur .video-webm":"saveWebm","click .video-webm-test":"testWebm","blur .video-mp4":"saveMp4","click .video-mp4-test":"testMp4","blur .video-ytid":"saveYtid","click .video-ytid-test":"testYtid","blur .video-duration":"saveDuration","click .video-triggers-fill-straight":"triggersFillStraight","click .video-triggers-fill-staggered":"triggersFillStaggered","click .video-triggers-sort":"triggersSort","click .video-triggers-clear":"triggersClear","blur .video-triggers-edit input":"triggerEditInput"},render:function(){$(this.el).html(this.template(this.model.toJSON()));return this},initialize:function(){this.render(),this.$(".video-edit-triggers").button({icons:{primary:"ui-icon-tag"}}),this.$(".video-edit-sources").button({icons:{primary:"ui-icon-pencil"}}),this.$(".video-addplayer").button({icons:{primary:"ui-icon-plus"}}),this.$(".video-delete").button({icons:{primary:"ui-icon-trash"},text:!1}),this.$(".video-triggers").hide(),this.$(".video-triggers button").button(),this.$(".video-sources").hide(),this.$(".video-ytid-test").button({icons:{primary:"ui-icon-video"}}),this.$(".video-webm-test").button({icons:{primary:"ui-icon-video"}}),this.$(".video-mp4-test").button({icons:{primary:"ui-icon-video"}});return this.model.get("Composition").View.$(".videos").append($(this.el))},saveTitle:function(){return this.model.set({title:this.$(".video-title").text().trim()})},editTriggers:function(){return this.$(".video-triggers").toggle("fast")},triggersFillStraight:function(){var a,b,c,d,e;b=parseFloat(this.model.get("duration"));if(b===b){a=b/App.triggers.length,d=[];for(c=0,e=App.triggers.length-1;0<=e?c<=e:c>=e;0<=e?c+=1:c-=1)d.push(c*a);this.model.set({triggers:d});return this.updateTriggers()}},triggersFillStaggered:function(){var a,b,c,d,e,f,g;c=parseFloat(this.model.get("duration"));if(c===c){b=c/App.triggers.length,f=[];for(d=0,g=App.triggers.length-1;0<=g?d<=g:d>=g;0<=g?d+=1:d-=1)e=Math.floor(d/4),a=Math.floor(d%4),f[a*10+e]=d*b;this.model.set({triggers:f});return this.updateTriggers()}},triggersSort:function(){var a,b;b=this.model.get("triggers"),a=b.sort(function(a,b){return a===null?1:b===null?-1:a-b}),this.model.set({triggers:a});return this.updateTriggers()},triggersClear:function(){this.model.set({triggers:[0]});return this.updateTriggers()},triggerEditInput:function(a){var b,c,d;c=$(a.target),b=c.attr("data-idx"),d=parseFloat(c.val());if(d===d)return this.model.addTrigger(b,d)},editSources:function(){this.$(".video-test").empty();return this.$(".video-sources").toggle("fast")},saveWebm:function(){var a;a=this.$(".video-webm").val().trim();return this.model.set({webm:a})},saveMp4:function(){var a;a=this.$(".video-mp4").val().trim();return this.model.set({mp4:a})},saveYtid:function(){var a;a=this.$(".video-ytid").val().trim(),a.indexOf("youtube.com")!==-1&&(a=a.split("v=")[1].split("&")[0],this.$(".video-ytid").val(a));return this.model.set({ytid:a})},saveDuration:function(){var a;a=parseFloat(this.$(".video-duration").val());if(a===a)return this.model.set({duration:a})},setDuration:function(a){a=parseFloat(a);if(a===a){this.$(".video-duration").val(a),this.saveDuration();if(this.model.get("triggers").length===0)return this.triggersFillStaggered()}},testFirst:function(){var a,b,c;b=this.model.get("webm");if(_.isString(b)&&b!=="")this.testWebm();else{a=this.model.get("mp4");if(_.isString(a)&&a!==""){this.testMp4();return}c=this.model.get("ytid"),_.isString(c)&&c!==""&&this.testYtid()}},testWebm:function(){var a,b,c;c=this.model.get("webm");if(_.isString(c)&&c!==""){b=this.testHtml5(),a=$("<source />").attr({src:c,type:"video/webm"}),b.append(a);return this.$(".video-test").append(b)}},testMp4:function(){var a,b,c;this.testHtml5(),a=this.model.get("mp4");if(_.isString(a)&&a!==""){c=this.testHtml5(),b=$("<source />").attr({src:a,type:"video/mp4"}),c.append(b);return this.$(".video-test").append(c)}},testHtml5:function(){var a;$(".video-test").empty(),a=$('<video autobuffer="metadata" controls></video>').data({video_id:this.model.cid}).bind("loadedmetadata",function(){var a;a=$(this).data("video_id");return App.Composition.Videos.getByCid(a).View.setDuration(this.duration)});return a},testYtid:function(){var a,b,c,d;$(".video-test").empty(),d=this.model.get("ytid");if(_.isString(d)&&d!==""){c=$('<div id="yt_test_d"></div>').data({ytid:d,video_id:this.model.cid}),c.append($('<div id="yt_test"></div>')),this.$(".video-test").append(c),b={allowScriptAccess:"always",wmode:"opaque"},a={id:"yt_test"};return swfobject.embedSWF("http://www.youtube.com/e/"+d+"?enablejsapi=1&version=3&playerapiid=test","yt_test","480","360","8",null,null,b,a)}},addPlayer:function(){var a;a=parseFloat(this.model.get("duration"));if(a!==a)alert("Please [Edit sources] and input the video's duration before adding a player.");else{this.model.addPlayer();return _gaq.push(["_trackEvent","Video","Add Player "+this.model.get("ytid"),JSON.stringify(this.model)])}},updateTriggers:function(){var a,b,c,d,e,f,g;f="",a=parseFloat(this.model.get("duration"));if(a===a&&a>0){e=this.model.get("triggers");for(b=0,g=App.triggers.length-1;0<=g?b<=g:b>=g;0<=g?b+=1:b-=1)d=e[b],d!==null&&d>=0?(this.$(".video-triggers-edit-"+b+" input").val(d),c=d/a*100,c<=100&&(f+="<span class='showtrigger v_"+this.model.cid+"_t_"+b+"' style='left:"+c+"%;'>"+App.triggers[b]+"</span>")):this.$(".video-triggers-edit-"+b+" input").val("");return $(".showtriggers_"+this.model.cid).html(f)}},"delete":function(){if(confirm("Are you sure you want to remove this video ("+this.model.cid+") and all players?")){$(this.el).remove();return this.model.remove()}}}),window.onYouTubePlayerReady=function(a){var b,c;b=document.getElementById("yt_test"),c=$("#yt_test_d").data("ytid"),b.loadVideoById(c,0,"medium"),b.addEventListener("onError","onPlayerError");return b.addEventListener("onStateChange","onPlayerStateChange")},window.onPlayerError=function(a){var b;switch(a){case 2:b="invalid video id";break;case 100:b="video not found";break;case 101:case 150:b="embedding not allowed";break;default:b="unknown error"}return alert("youtube error "+a+": "+b)},window.onPlayerStateChange=function(a){var b,c;if(a===1){b=document.getElementById("yt_test"),c=$(b).parent().data("video_id");return App.Composition.Videos.getByCid(c).View.setDuration(b.getDuration())}}}.call(this),function(){this.Player=Backbone.Model.extend({defaults:{volume:100},initialize:function(){if(this.get("Composition")===App.Composition)return this.initializeView()},initializeView:function(){this.View=new PlayerView({model:this});return this.set({playing:!0})},remove:function(){return this.get("Video").Players.remove(this)},change:function(){return this.View.updateinfo()},toJSON:function(){var a;return a={id:this.cid,volume:parseInt(this.get("volume"))}}}),this.PlayerList=Backbone.Collection.extend({model:Player})}.call(this),function(){this.PlayerView=Backbone.View.extend({tagName:"div",className:"control",template:_.template($("#control-template").html()),lastTrigger:0,events:{"click .playbutton":"play","click .pausebutton":"pause","click .mutebutton":"mute","click .unmutebutton":"unmute","slide .volumeslider":"volume","click .addtriggerbutton":"addtrigger","click .removebutton":"removeConfirm","mouseover .playprogress":"playprogressOver","click .playprogress":"playprogressClick","keydown .playprogress":"playprogressKey"},playpause:function(){return this.model.get("playing")?this.pause():this.play()},play:function(){this.model.set({playing:!0});return window.App.postMessageToViewer("play",this.model.cid)},pause:function(){this.model.set({playing:!1});return window.App.postMessageToViewer("pause",this.model.cid)},mute:function(){return window.App.postMessageToViewer("mute",this.model.cid)},unmute:function(){return window.App.postMessageToViewer("unmute",this.model.cid)},volume:function(a,b){this.model.set({volume:b.value});return window.App.postMessageToViewer("volume",this.model.cid,b.value)},removeConfirm:function(){if(confirm("Are you sure you want to remove this player ("+this.model.cid+")?"))return this.remove()},remove:function(){window.App.postMessageToViewer("remove",this.model.cid),$(this.el).remove();return this.model.remove()},addtrigger:function(){var a,b,c,d,e,f,g,h;if(this.model.get("totaltime")>0){c=0,g=this.model.get("Video").get("triggers");for(e=0,f=g.length;e<f;e++)d=g[e],d>c&&(c=Math.ceil(d));a=this.model.get("Video").get("triggers").length,h=[];for(b=0;b<=8;b++)h.push(this.model.get("Video").addTrigger(a+b,c+(b+1)*2));return h}},playprogressOver:function(a){return $(a.currentTarget).focus()},playprogressClick:function(a){var b;b=(a.layerX-5)/$(a.currentTarget).width();return this.seek(b*this.model.get("totaltime"))},seek:function(a){return window.App.postMessageToViewer("seek",this.model.cid,a)},focusPrev:function(){this.$(".playprogress").parent().prev().children(".playprogress").focus();return!1},focusNext:function(){this.$(".playprogress").parent().next().children(".playprogress").focus();return!1},playprogressKey:function(a){switch(a.keyCode){case 32:this.playpause();break;case 38:this.focusPrev();break;case 40:this.focusNext();break;case 37:this.triggerArp(!0);break;case 39:this.triggerArp(!1);break;default:this.triggerCode(a.keyCode)}return!1},triggerCode:function(a){var b;b=App.keycodes.indexOf(a);if(b!==-1)return this.triggerOrAdd(b)},triggerOrAdd:function(a){var b;b=parseFloat(this.model.get("Video").get("triggers")[a]);if(b!==b)return this.model.get("Video").addTrigger(a,this.model.get("time"));this.lastTrigger=a;return this.seek(b)},trigger:function(a){var b;b=this.model.get("Video").get("triggers")[a];if(b!==void 0&&b!==null){this.lastTrigger=a;return this.seek(b)}},triggerArp:function(a){var b,c;b=this.lastTrigger,c=null;if(a){while(b>0&&(c===null||c===void 0))b--,c=this.model.get("Video").get("triggers")[b];b===0&&(c=0)}else while(b<this.model.get("Video").get("triggers").length-1&&(c===null||c===void 0))b++,c=this.model.get("Video").get("triggers")[b];if(c!==void 0&&c!==null){this.lastTrigger=b;return this.seek(c)}},render:function(){$(this.el).html(this.template(this.model.toJSON()));return this},updateinfo:function(){if(this.model.get("totalsize")>0){this.$(".statusmessage").html(""+this.model.get("time")+" / "+this.model.get("totaltime")+" <br /> "+this.model.get("loaded")+" / "+this.model.get("totalsize")),this.$(".playprogress").progressbar("value",this.model.get("time")/this.model.get("totaltime")*100);return this.$(".loadprogress").progressbar("value",this.model.get("loaded")/this.model.get("totalsize")*100)}},create:function(){var a,b,c,d;b=this.model.get("Video"),c=b.get("webm"),a=b.get("mp4"),d=b.get("ytid");return c&&c!==""&&Modernizr.video&&Modernizr.video.webm!=="no"?App.postMessageToViewer("createW",this.model.cid,encodeURIComponent(c)):a&&a!==""&&Modernizr.video&&Modernizr.video.mp4!=="no"?App.postMessageToViewer("createM",this.model.cid,encodeURIComponent(a)):d&&d!==""?App.postMessageToViewer("createY",this.model.cid,d):alert("You can't play this video in this browser (;_;)")},initialize:function(){this.create(),this.render(),this.$(".playbutton").button({icons:{primary:"ui-icon-play"},text:!1}),this.$(".pausebutton").button({icons:{primary:"ui-icon-pause"},text:!1}),this.$(".mutebutton").button({icons:{primary:"ui-icon-volume-off"},text:!1}),this.$(".unmutebutton").button({icons:{primary:"ui-icon-volume-on"},text:!1}),this.$(".volumeslider").slider({value:100,min:0,max:100}),this.$(".addtriggerbutton").button({icons:{primary:"ui-icon-plus"},text:!1}),this.$(".removebutton").button({icons:{primary:"ui-icon-trash"},text:!1}),this.$(".playprogress").progressbar({value:0}),this.$(".loadprogress").progressbar({value:0}),this.model.get("Composition").View.$(".players").append($(this.el)),this.model.get("Video").View.updateTriggers();return this}})}.call(this),function(){this.Pattern=Backbone.Model.extend({defaults:{trigger_id:0,chance:1,beats:16,next:0},initialize:function(){this.Tracks=new TrackList;return this.beat=0},initializeView:function(){var a,b,c,d,e;this.View=new PatternView({model:this,id:"pattern_"+this.cid}),d=this.Tracks.models,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(a.initializeView());return e},addTracks:function(){var a,b,c,d,e,f;e=this.get("Composition").Videos.models,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(function(){var c,d,e,f;e=b.Players.models,f=[];for(c=0,d=e.length;c<d;c++)a=e[c],f.push(this.addTrack(a));return f}.call(this));return f},addTrack:function(a){var b;b=new Track({Pattern:this,Player:a}),this.Tracks.add(b);return b},toJSON:function(){var a;return a={id:this.cid,trigger_id:parseInt(this.get("trigger_id")),chance:parseInt(this.get("chance")),next:parseInt(this.get("next")),beats:parseInt(this.get("beats")),tracks:this.Tracks}},play:function(){this.get("Composition").cuePattern(this);return this.beat=0},stop:function(){this.get("Composition").stop();return this.beat=0},step:function(){var a,b,c,d,e,f;this.beat===0&&this.View.startPlaying(),f=this.Tracks.models;for(d=0,e=f.length;d<e;d++)b=f[d],c=b.Line[this.beat],c!==null&&c!==void 0&&(a=b.get("Player").get("Video").get("triggers")[c],a!==null&&a!==void 0&&this.get("Composition").queueMessage("/seek/"+b.get("Player").cid+"/"+a));this.View.step(),this.beat++;if(this.beat>=this.get("beats")){this.beat=0;return this.get("Composition").loop()}},"delete":function(){this.destroy();return this.View.remove()}}),this.PatternList=Backbone.Collection.extend({model:Pattern})}.call(this),function(){this.PatternView=Backbone.View.extend({tagName:"div",className:"pattern",template:_.template($("#pattern-template").html()),events:{"click .pattern_addtrack_button":"chooseTrack","mouseover .navigable":"mouseoverNavigable","change .pattern_beats":"setBeats","blur .pattern_beats":"setBeats","change .pattern_chance":"setChance","blur .pattern_chance":"setChance","click .pattern_play_button":"play","click .pattern_stop_button":"stop","keydown .pattern_trigger":"setTrigger","keydown .pattern_next":"setNext"},render:function(){$(this.el).html(this.template(this.model.toJSON()));return this},mouseoverNavigable:function(a){return $(a.currentTarget).focus()},setChance:function(a){return this.model.set({chance:parseInt($(a.currentTarget).val())})},setTrigger:function(a){var b;b=App.keycodes.indexOf(a.keyCode),b!==-1&&(this.model.set({trigger_id:b}),$(a.currentTarget).text(App.triggers[b]));return!1},setNext:function(a){var b;b=App.keycodes.indexOf(a.keyCode),b!==-1&&(this.model.set({next:b}),$(a.currentTarget).text(App.triggers[b]));return!1},startPlaying:function(){this.$(".beat").removeClass("cue");return $(".patterns .beat").removeClass("active")},initialize:function(){this.render(),this.$(".pattern_play_button").button({icons:{primary:"ui-icon-play"},text:!1}),this.$(".pattern_stop_button").button({icons:{primary:"ui-icon-stop"},text:!1}),this.$(".pattern_addtrack_button").button({icons:{primary:"ui-icon-plus"}}),this.$(".navigable").attr("tabindex",0);return this.model.get("Composition").View.$(".patterns").append($(this.el))},"delete":function(){if(confirm("Are you sure you want to remove this pattern ("+this.model.get("title")+")?"))return this.model["delete"]()},play:function(){this.model.play(),$(".pattern_trigger").removeClass("cue");return this.$(".pattern_trigger").addClass("cue")},stop:function(){this.model.stop();return this.$(".beat").removeClass("active")},chooseTrack:function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o;b=$("<div></div>"),m=this.model.get("Composition").Videos.models;for(g=0,j=m.length;g<j;g++){f=m[g],n=f.Players.models;for(h=0,k=n.length;h<k;h++){d=n[h],c=!1,o=this.model.Tracks.models;for(i=0,l=o.length;i<l;i++)e=o[i],e.get("Player").cid===d.cid&&(c=!0);a=$("<div>"+d.cid+"</div>"),a.data({pattern_id:this.model.cid,player_id:d.cid}).button({disabled:c}).click(function(){var a,c;a=$(this).data("pattern_id"),c=$(this).data("player_id"),App.Composition.Patterns.getByCid(a).View.addTrack(c);return $(b).dialog("close")}),b.append(a)}}$(this.el).append(b);return b.dialog()},addTrack:function(a){var b;b=this.model.addTrack(App.Composition.getPlayerByCid(a));return b.initializeView()},setBeats:function(){var a,b,c,d,e,f;a=this.$(".pattern_beats").val(),this.model.set({beats:a}),e=this.model.Tracks.models,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(b.View.initialize());return f},step:function(){this.$(".beat").removeClass("active");return this.$(".beat_"+this.model.beat).addClass("active")},remove:function(){return $(this.el).remove()}})}.call(this),function(){this.Track=Backbone.Model.extend({initialize:function(){this.Line=[];return this.pattern_id=this.get("Pattern").cid},initializeView:function(){return this.View=new TrackView({model:this,Pattern:this.get("Pattern")})},setLine:function(a){return this.Line=a},addTrigger:function(a,b){return this.Line[a]=b},setBeat:function(a,b){this.Line[a]=b;if(this.View)return this.View.setBeat(a,b)},toJSON:function(){var a;return a={player_id:this.get("Player").cid,line:this.Line}},"delete":function(){this.destroy();return this.View.remove()}}),this.TrackList=Backbone.Collection.extend({model:Track})}.call(this),function(){this.TrackView=Backbone.View.extend({tagName:"div",className:"track",template:_.template($("#track-template").html()),events:{"keydown .beat":"beatKeydown"},render:function(){$(this.el).html(this.template(this.model.toJSON()));return this},initialize:function(){var a,b,c,d,e;$(this.el).empty(),this.Beats=[],this.render(),b=this.model.get("Pattern").get("beats");for(d=0,e=b-1;0<=e?d<=e:d>=e;0<=e?d+=1:d-=1){c=App.triggers[this.model.Line[d]];if(c===null||c===void 0)c="&nbsp;";a=$("<span class='beat beat_"+d+" navigable'>"+c+"</span>"),a.data("beat",d),$(this.el).append(a),this.Beats[d]=a}this.$(".navigable").attr("tabindex",0);return this.model.get("Pattern").View.$(".pattern_tracks").append($(this.el))},beatKeydown:function(a){var b;b=$(a.currentTarget).data("beat");switch(a.keyCode){case 9:return!0;case 8:this.focusPrev(b);break;case 46:this.focusPrev(b);break;case 38:this.focusPrevTrack(b);break;case 40:this.focusNextTrack(b);break;case 37:this.focusPrev(b);break;case 39:this.focusNext(b);break;default:this.setBeatKeycode(b,a.keyCode);return!1}return!1},setBeatKeycode:function(a,b){var c,d;d=App.keycodes.indexOf(b);if(d===-1)if(b===32||b===8||b===46||b===27)d=null;else return;c=d===null?"&nbsp;":App.triggers[d],this.Beats[a].html(c),this.model.setBeat(a,d);return b!==32&&d===null?this.focusPrev(a):this.focusNext(a)},focusPrev:function(a){var b;(b=this.Beats[a-1])?b.focus():(b=this.Beats[this.Beats.length-1])&&b.focus();return!1},focusNext:function(a){var b;(b=this.Beats[a+1])?b.focus():(b=this.Beats[0])&&b.focus();return!1},focusPrevTrack:function(a){var b;(b=this.Beats[a].parent().prev().children(".beat_"+a))&&b.focus();return!1},focusNextTrack:function(a){var b;(b=this.Beats[a].parent().next().children(".beat_"+a))&&b.focus();return!1},setBeat:function(a,b){var c;c=b===null?"&nbsp;":App.triggers[b];return this.Beats[a].html(c)},"delete":function(){if(confirm("Are you sure you want to remove this pattern ("+this.model.get("title")+")?"))return this.model["delete"]()},remove:function(){return $(this.el).remove()}})}.call(this),function(){this.Sequence=Backbone.Model.extend({defaults:{length:16},initialize:function(){this.Tracks=new SequenceTrackList;return this.beat=-1},initializeView:function(){var a,b,c,d,e;this.View=new SequenceView({model:this}),d=this.Tracks.models,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(a.initializeView());return e},toJSON:function(){var a;return a={id:this.cid,length:parseInt(this.get("length")),tracks:this.Tracks}},"delete":function(){this.destroy();return this.View.remove()},addTrack:function(){var a;a=new SequenceTrack({Sequence:this}),this.Tracks.add(a);return a},cue:function(a){return this.beat=a-1},play:function(){return this.get("Composition").cueSequence(this)},stop:function(){this.beat=-1;return this.get("Composition").stopSequence(this)},step:function(){var a;this.beat++,this.beat>=this.get("length")&&(this.beat=0),this.View.step(),a=this.Tracks.models[0].Line[this.beat],a===void 0&&(a=null);return a}}),this.SequenceList=Backbone.Collection.extend({model:Sequence})}.call(this),function(){this.SequenceView=Backbone.View.extend({tagName:"div",className:"sequence",template:_.template($("#sequence-template").html()),events:{"mouseover .navigable":"mouseoverNavigable","change .sequence_length":"setLength","blur .sequence_length":"setLength","click .sequence_play_button":"play","click .sequence_stop_button":"stop"},render:function(){$(this.el).html(this.template(this.model.toJSON()));return this},initialize:function(){this.render(),this.$(".sequence_play_button").button({icons:{primary:"ui-icon-play"},text:!1}),this.$(".sequence_stop_button").button({icons:{primary:"ui-icon-stop"},text:!1}),this.$(".navigable").attr("tabindex",0);return this.model.get("Composition").View.$(".sequences").append($(this.el))},mouseoverNavigable:function(a){return $(a.currentTarget).focus()},"delete":function(){if(confirm("Are you sure you want to remove this composition ("+this.model.get("title")+")?"))return this.model["delete"]()},setLength:function(){var a,b,c,d,e,f;a=this.$(".sequence_length").val();if(0<a&&a<1e3){this.model.set({length:a}),e=this.model.Tracks.models,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(b.View.initialize());return f}},remove:function(){return $(this.el).remove()},play:function(){return this.model.play()},stop:function(){this.model.stop();return this.$(".beat").removeClass("active")},step:function(){this.$(".beat").removeClass("cue"),$(".sequencetrack .beat").removeClass("active");return this.$(".beat_"+this.model.beat).addClass("active")}})}.call(this),function(){this.SequenceTrack=Backbone.Model.extend({initialize:function(){return this.Line=[]},initializeView:function(){return this.View=new SequenceTrackView({model:this})},setLine:function(a){return this.Line=a},addTrigger:function(a,b){return this.Line[a]=b},setBeat:function(a,b){this.Line[a]=b;if(this.View)return this.View.setBeat(a,b)},toJSON:function(){var a;return a={line:this.Line}},"delete":function(){this.destroy();return this.View.remove()}}),this.SequenceTrackList=Backbone.Collection.extend({model:Track})}.call(this),function(){this.SequenceTrackView=Backbone.View.extend({tagName:"div",className:"sequencetrack",template:_.template($("#sequencetrack-template").html()),events:{"keydown .beat":"beatKeydown","click .beat":"cueBeat"},render:function(){$(this.el).html(this.template(this.model.toJSON()));return this},initialize:function(){var a,b,c,d,e;$(this.el).empty(),this.Beats=[],this.render(),d=this.model.get("Sequence").get("length");for(c=0,e=d-1;0<=e?c<=e:c>=e;0<=e?c+=1:c-=1){b=App.triggers[this.model.Line[c]];if(b===null||b===void 0)b="&nbsp;";a=$("<span class='sequencebeat beat beat_"+c+" navigable'>"+b+"</span>"),a.data("beat",c),$(this.el).append(a),this.Beats[c]=a}this.$(".navigable").attr("tabindex",0);return this.model.get("Sequence").View.$(".sequence_tracks").append($(this.el))},cueBeat:function(a){var b,c;this.$(".beat").removeClass("cue"),b=$(a.currentTarget).data("beat"),c=this.Beats[b],c.addClass("cue");return this.model.get("Sequence").cue(b)},beatKeydown:function(a){var b;b=$(a.currentTarget).data("beat");switch(a.keyCode){case 9:return!0;case 8:this.focusPrev(b);break;case 46:this.focusPrev(b);break;case 38:this.focusPrevTrack(b);break;case 40:this.focusNextTrack(b);break;case 37:this.focusPrev(b);break;case 39:this.focusNext(b);break;default:this.setBeatKeycode(b,a.keyCode);return!1}return!1},setBeatKeycode:function(a,b){var c,d;d=App.keycodes.indexOf(b);if(d===-1)if(b===32||b===8||b===46||b===27)d=null;else return;c=d===null?"&nbsp;":App.triggers[d],this.Beats[a].html(c),this.model.setBeat(a,d);return b!==32&&d===null?this.focusPrev(a):this.focusNext(a)},focusPrev:function(a){var b;(b=this.Beats[a-1])?b.focus():(b=this.Beats[this.Beats.length-1])&&b.focus();return!1},focusNext:function(a){var b;(b=this.Beats[a+1])?b.focus():(b=this.Beats[0])&&b.focus();return!1},focusPrevTrack:function(a){var b;(b=this.Beats[a].parent().prev().children(".beat_"+a))&&b.focus();return!1},focusNextTrack:function(a){var b;(b=this.Beats[a].parent().next().children(".beat_"+a))&&b.focus();return!1},setBeat:function(a,b){var c;c=b===null?"&nbsp;":App.triggers[b];return this.Beats[a].html(c)},"delete":function(){if(confirm("Are you sure you want to remove this pattern ("+this.model.get("title")+")?"))return this.model["delete"]()},remove:function(){return $(this.el).remove()}})}.call(this),function(){var a;this.AppView=Backbone.View.extend({template:_.template($("#application-template").html()),triggers_us:["1","2","3","4","5","6","7","8","9","0","q","w","e","r","t","y","u","i","o","p","a","s","d","f","g","h","j","k","l",";","z","x","c","v","b","n","m",",",".","/"],keycodes_us:[49,50,51,52,53,54,55,56,57,48,81,87,69,82,84,89,85,73,79,80,65,83,68,70,71,72,74,75,76,186,90,88,67,86,66,78,77,188,190,191],initialize:function(){$("#intro").hide(),$("#application").html(this.template),this.timer=null,this.triggers=this.triggers_us,this.keycodes=this.keycodes_us,this.viewer=document.getElementById("viewer").contentWindow,$("#popoutbutton").button({icons:{primary:"ui-icon-newwin"}}).click(function(){return App.popoutViewer()}),$("#viewer-reload").button({icons:{primary:"ui-icon-refresh"}}).click(function(){return App.reloadVideos()}),$("#newcomposition").button({icons:{primary:"ui-icon-document"}}).click(function(){var a;if(!(App.Composition&&App.Composition.changesMade()&&!confirm("You have unsaved changes in the current composition. Discard unsaved changes?"))){a=new Composition,App.Compositions.add(a);return App.loadComposition(a)}}),$("#loadcomposition").button({icons:{primary:"ui-icon-folder-open"}}).click(function(){return $("#comp_dialog").dialog({width:400,position:"right top"})});return $("#comp_import_button").button({icons:{primary:"ui-icon-arrowthickstop-1-s"}}).click(function(){var a;a=$("#comp_import_text").val().replace(/(\r\n|\n|\r)/gm," "),App.loadComposition(App.Compositions.create({loadJSON:a}));return $("#comp_import_text").val("")})},initializeCompositions:function(){var a;this.Compositions=new CompositionList,this.Compositions.fetch();if(this.Compositions.length>0)return this.loadComposition(this.Compositions
.at(this.Compositions.length-1));a=new Composition,App.Compositions.add(a);return App.loadComposition(a)},loadComposition:function(a){try{this.Composition.View.remove()}catch(b){}this.Composition=a;return this.Composition.initializeView()},popoutViewer:function(){this.viewer=window.open("meemoo-viewer.html","popoutviewer"),$("#container").hide(),$("#viewer").remove();return $("#setup").addClass("floatingsetup")},popinViewer:function(){if($("#viewer").length===0){$("#container").prepend('<iframe src="meemoo-viewer.html" id="viewer" name="inviewer"></iframe>'),this.viewer=document.getElementById("viewer").contentWindow,$("#container").show();return $("#setup").removeClass("floatingsetup")}},reloadVideos:function(){var a,b,c,d,e,f;this.postRawMessageToViewer("/remove/ALL"),e=App.Composition.Videos.models,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(function(){var c,d,e,f;e=b.Players.models,f=[];for(c=0,d=e.length;c<d;c++)a=e[c],a.set({loaded:0,time:0}),f.push(a.View.create());return f}());return f},postMessageToViewer:function(a,b,c){return this.postRawMessageToViewer("/"+a+"/"+b+"/"+c)},postRawMessageToViewer:function(a){return this.viewer.postMessage(a,window.location.protocol+"//"+window.location.host)},recieveMessage:function(a){var b,c,d,e,f,g,h,i,j,k,l,m;if(!!this.Composition){if(a==="-=POPOUTCLOSED=-")return this.popinViewer();if(a==="-=REFRESH=-")return setTimeout("App.reloadVideos()",2e3);g=a.split("|"),m=[];for(k=0,l=g.length;k<l;k++)f=g[k],c=f.split(":"),b=c[0],d=c[1],i=c[2],h=c[3],j=c[4],m.push(b!==""?(e=this.Composition.getPlayerByCid(b),e?e.set({loaded:d,totalsize:i,time:h,totaltime:j}):void 0):void 0);return m}}}),a=function(a){if(a.origin===window.location.protocol+"//"+window.location.host){App.recieveMessage(a.data);return a.data}},window.addEventListener("message",a,!1),window.onbeforeunload=function(a){if(App.Composition&&App.Composition.changesMade())return"You are closing with unsaved changes. Discard unsaved changes?"}}.call(this)